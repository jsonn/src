***************
*** 76,81 ****
  {
  	struct bootpath *bp = bootpath_store(0, NULL); /* restore bootpath! */
  	struct scsibus_softc *sbsc;
  	int target, lun;
  
  	if (bp == NULL)
--- 76,83 ----
  {
  	struct bootpath *bp = bootpath_store(0, NULL); /* restore bootpath! */
  	struct scsibus_softc *sbsc;
+ 	struct scsipi_channel *chan;
+ 	struct scsipi_periph *periph;
  	int target, lun;
  
  	if (bp == NULL)
***************
*** 88,99 ****
  	    strncmp("cd", dev->dv_xname, 2) == 0) {
  
  		sbsc = (struct scsibus_softc *)dev->dv_parent;
  
  		target = bp->val[0];
  		lun = bp->val[1];
  
  		if (CPU_ISSUN4 && dev->dv_xname[0] == 's' &&
- 		    target == 0 && sbsc->sc_link[0][0] == NULL) {
  			/*
  			 * disk unit 0 is magic: if there is actually no
  			 * target 0 scsi device, the PROM will call
--- 90,102 ----
  	    strncmp("cd", dev->dv_xname, 2) == 0) {
  
  		sbsc = (struct scsibus_softc *)dev->dv_parent;
+ 		chan = sbsc->sc_channel;
  
  		target = bp->val[0];
  		lun = bp->val[1];
  
  		if (CPU_ISSUN4 && dev->dv_xname[0] == 's' &&
+ 		    target == 0 && scsipi_lookup_periph(chan, 0, 0) == NULL) {
  			/*
  			 * disk unit 0 is magic: if there is actually no
  			 * target 0 scsi device, the PROM will call
***************
*** 107,114 ****
  		if (CPU_ISSUN4C && dev->dv_xname[0] == 's')
  			target = sd_crazymap(target);
  
- 		if (sbsc->sc_link[target][lun] != NULL &&
- 		    sbsc->sc_link[target][lun]->device_softc == (void *)dev) {
  			bp->dev = dev;	/* got it! */
  			return;
  		}
--- 110,118 ----
  		if (CPU_ISSUN4C && dev->dv_xname[0] == 's')
  			target = sd_crazymap(target);
  
+ 		periph = scsipi_lookup_periph(chan, target, lun);
+ 		if (periph != NULL &&
+ 		    periph->periph_dev == (void *)dev) {
  			bp->dev = dev;	/* got it! */
  			return;
  		}
