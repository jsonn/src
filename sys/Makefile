#	$NetBSD: Makefile,v 1.20.2.2 1997/10/13 21:21:04 cjs Exp $

# The ``rm -rf''s used below are safe because rm doesn't follow symbolic
# links.

.include <bsd.own.mk>   # for BUILDDIR

SUBDIR+= arch/${MACHINE}

.if (${MACHINE_ARCH} != "alpha" && ${MACHINE_ARCH} != "mips" && \
     ${MACHINE_ARCH} != "powerpc")
SUBDIR+= lkm
.endif

LFILES=	errno.h fcntl.h md5.h poll.h syslog.h termios.h
MFILES=	float.h frame.h stdarg.h varargs.h
LDIRS=	dev isofs net netatalk netinet netccitt netiso netns netnatm nfs miscfs \
	sys ufs vm 

# Change SYS_INCLUDE in bsd.own.mk or /etc/mk.conf to "symlinks" if you
# don't want copies
.include <bsd.own.mk>
SYS_INCLUDE?=	copies

.PHONY: includes
.if defined(BUILDDIR)
includes: build_${SYS_INCLUDE}
	@echo installing ${LFILES}
	@-for i in ${LFILES}; do \
		rm -f ${BUILDDIR}/usr/include/$$i; \
		ln -s sys/$$i ${BUILDDIR}/usr/include/$$i; \
	done
	@echo installing ${MFILES}
	@-for i in ${MFILES}; do \
		rm -f ${BUILDDIR}/usr/include/$$i; \
		ln -s machine/$$i ${BUILDDIR}/usr/include/$$i; \
	done
.else
includes: install_${SYS_INCLUDE}
.endif

build_copies:
	@echo copies: ${LDIRS}
	@-for i in ${LDIRS}; do \
		rm -rf ${BUILDDIR}/usr/include/$$i; \
		${INSTALL} -d -m 755 ${BUILDDIR}/usr/include/$$i ; \
	done
	pax -rw -pa -L \
	    `find ${LDIRS} -follow -type f -name '*.h' '!' -path \
	    'netiso/xebec/*' -print` ${BUILDDIR}/usr/include
	rm -rf ${BUILDDIR}/usr/include/machine
	${INSTALL} -d -m 755 ${BUILDDIR}/usr/include/machine
	pax -rw -pa -s "|arch/${MACHINE}/include||" \
	    arch/${MACHINE}/include/*.h \
	    ${BUILDDIR}/usr/include/machine   
	rm -rf ${BUILDDIR}/usr/include/${MACHINE_ARCH}
	if test ${MACHINE} != ${MACHINE_ARCH} -a \
	    -d arch/${MACHINE_ARCH}/include; then \
		${INSTALL} -d -m 755 ${BUILDDIR}/usr/include/${MACHINE_ARCH}; \
		pax -rw -pa -s "|arch/${MACHINE_ARCH}/include||" \
		    arch/${MACHINE_ARCH}/include/*.h \
		    ${BUILDDIR}/usr/include/${MACHINE_ARCH}; \
	else \
		ln -s machine ${BUILDDIR}/usr/include/${MACHINE_ARCH}; \
	fi

build_symlinks:
	@echo symlinks: ${LDIRS}
	@for i in ${LDIRS}; do \
		rm -rf ${BUILDDIR}/usr/include/$$i; \
		ln -s ${BSDSRCDIR}/sys/$$i ${BUILDDIR}/usr/include/$$i; \
	done
	rm -rf ${BUILDDIR}/usr/include/machine
	ln -s ${BSDSRCDIR}/sys/arch/${MACHINE}/include \
	    ${BUILDDIR}/usr/include/machine
	rm -rf ${BUILDDIR}/usr/include/${MACHINE_ARCH}
	if test ${MACHINE} != ${MACHINE_ARCH} -a \
	    -d arch/${MACHINE_ARCH}/include ; then \
		ln -s ${BSDSRCDIR}/sys/arch/${MACHINE_ARCH}/include \
		    ${BUILDDIR}/usr/include/${MACHINE_ARCH} ; \
	else \
		ln -s machine ${BUILDDIR}/usr/include/${MACHINE_ARCH} ; \
	fi

install: install_${SYS_INCLUDE}
	@echo installing ${LFILES}
	@-for i in ${LFILES}; do \
		rm -f ${DESTDIR}/usr/include/$$i; \
		ln -s sys/$$i ${DESTDIR}/usr/include/$$i; \
	done
	@echo installing ${MFILES}
	@-for i in ${MFILES}; do \
		rm -f ${DESTDIR}/usr/include/$$i; \
		ln -s machine/$$i ${DESTDIR}/usr/include/$$i; \
	done

.PHONY:	install_copies
install_copies:
	@echo copies: ${LDIRS}
	@-for i in ${LDIRS}; do \
		rm -rf ${DESTDIR}/usr/include/$$i; \
		${INSTALL} -d -o ${BINOWN} -g ${BINGRP} -m 755 \
			${DESTDIR}/usr/include/$$i ; \
	done
	pax -rw -pa -L \
	    `find ${LDIRS} -follow -type f -name '*.h' '!' -path \
	    'netiso/xebec/*' -print` ${DESTDIR}/usr/include
	rm -rf ${DESTDIR}/usr/include/machine
	${INSTALL} -d -o ${BINOWN} -g ${BINGRP} -m 755 \
		${DESTDIR}/usr/include/machine
	pax -rw -pa -s "|arch/${MACHINE}/include||" \
	    arch/${MACHINE}/include/*.h \
	    ${DESTDIR}/usr/include/machine   
	rm -rf ${DESTDIR}/usr/include/${MACHINE_ARCH}
	if test ${MACHINE} != ${MACHINE_ARCH} -a \
	    -d arch/${MACHINE_ARCH}/include; then \
		${INSTALL} -d -o ${BINOWN} -g ${BINGRP} -m 755 \
		${DESTDIR}/usr/include/${MACHINE_ARCH}; \
		pax -rw -pa -s "|arch/${MACHINE_ARCH}/include||" \
		    arch/${MACHINE_ARCH}/include/*.h \
		    ${DESTDIR}/usr/include/${MACHINE_ARCH}; \
	else \
		ln -s machine ${DESTDIR}/usr/include/${MACHINE_ARCH}; \
	fi

.PHONY:	install_symlinks
install_symlinks:
	@echo symlinks: ${LDIRS}
	@for i in ${LDIRS}; do \
		rm -rf ${DESTDIR}/usr/include/$$i; \
		ln -s ${BSDSRCDIR}/sys/$$i ${DESTDIR}/usr/include/$$i; \
	done
	rm -rf ${DESTDIR}/usr/include/machine
	ln -s ${BSDSRCDIR}/sys/arch/${MACHINE}/include \
	    ${DESTDIR}/usr/include/machine
	rm -rf ${DESTDIR}/usr/include/${MACHINE_ARCH}
	if test ${MACHINE} != ${MACHINE_ARCH} -a \
	    -d arch/${MACHINE_ARCH}/include ; then \
		ln -s ${BSDSRCDIR}/sys/arch/${MACHINE_ARCH}/include \
		    ${DESTDIR}/usr/include/${MACHINE_ARCH} ; \
	else \
		ln -s machine ${DESTDIR}/usr/include/${MACHINE_ARCH} ; \
	fi

.include <bsd.subdir.mk>
