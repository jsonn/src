.\"	$NetBSD: sysinst,v 1.5.4.15 2002/03/06 21:28:10 he Exp $
.\"
.\" Copyright (c) 1999-2001 The NetBSD Foundation, Inc.
.\" All rights reserved.
.\"
.\" Redistribution and use in source and binary forms, with or without
.\" modification, are permitted provided that the following conditions
.\" are met:
.\" 1. Redistributions of source code must retain the above copyright
.\"    notice, this list of conditions and the following disclaimer.
.\" 2. Redistributions in binary form must reproduce the above copyright
.\"    notice, this list of conditions and the following disclaimer in the
.\"    documentation and/or other materials provided with the distribution.
.\" 3. All advertising materials mentioning features or use of this software
.\"    must display the following acknowledgement:
.\"        This product includes software developed by the NetBSD
.\"        Foundation, Inc. and its contributors.
.\" 4. Neither the name of The NetBSD Foundation nor the names of its
.\"    contributors may be used to endorse or promote products derived
.\"    from this software without specific prior written permission.
.\"
.\" THIS SOFTWARE IS PROVIDED BY THE NETBSD FOUNDATION, INC. AND CONTRIBUTORS
.\" ``AS IS'' AND ANY EXPRESS OR IMPLIED WARRANTIES, INCLUDING, BUT NOT LIMITED
.\" TO, THE IMPLIED WARRANTIES OF MERCHANTABILITY AND FITNESS FOR A PARTICULAR
.\" PURPOSE ARE DISCLAIMED.  IN NO EVENT SHALL THE FOUNDATION OR CONTRIBUTORS
.\" BE LIABLE FOR ANY DIRECT, INDIRECT, INCIDENTAL, SPECIAL, EXEMPLARY, OR
.\" CONSEQUENTIAL DAMAGES (INCLUDING, BUT NOT LIMITED TO, PROCUREMENT OF
.\" SUBSTITUTE GOODS OR SERVICES; LOSS OF USE, DATA, OR PROFITS; OR BUSINESS
.\" INTERRUPTION) HOWEVER CAUSED AND ON ANY THEORY OF LIABILITY, WHETHER IN
.\" CONTRACT, STRICT LIABILITY, OR TORT (INCLUDING NEGLIGENCE OR OTHERWISE)
.\" ARISING IN ANY WAY OUT OF THE USE OF THIS SOFTWARE, EVEN IF ADVISED OF THE
.\" POSSIBILITY OF SUCH DAMAGE.
.\"
.
.
.de (pcmcia
.	Bl -tag -width x[PCMCIA]x
.It [ Tn PCMCIA ]
..
.de pcmcia)
.	El
..
.
.
.Ss2 Running the sysinst installation program
.(enum
.To 2 Introduction
.Em Introduction
.Pp
Using
.Ic sysinst ,
installing
.Nx
is a relatively easy process. You
still should read this document and have it in hand when doing the
installation process. This document tries to be a good guideline
for the installation and as such covers many details to be completed.
Do not let this discourage you, the install program is not hard
to use.
.
.if !\n[macppc]:\n[news68k]:\n[pmax]:\n[sparc]:\n[x68k] \{\
.It
.To 2 "Possible PCMCIA issues"
.Em Possible Tn PCMCIA Em issues
.Pp
Machines with
.Tn PCMCIA
slots may have problems during installation. With the improvements of
the
.Tn PCMCIA
code in this release, this will not happen very frequently.
If you do not have
.Tn PCMCIA
on your machine
.Tn ( PCMCIA
is only really used on laptop machines),
you can skip this section, and ignore the
.Dq Bq Tn PCMCIA
notes. If you do have
.Tn PCMCIA
in your machine, you can safely ignore this section and the
.Dq Bq Tn PCMCIA
the first time, as you are likely to not have problems. Should troubles
occur during floppy boot, they may be
.Tn PCMCIA
specific. You should then re-read this section and try again,
following the instructions in the
.Dq Bq Tn PCMCIA
notes.
.Pp
This section explains how to work around the installation problem.
.Pp
The kernel keeps careful track of what interrupts
and I/O ports are in use during autoconfiguration. It then allows
the
.Tn PCMCIA
devices to pick unused interrupts and I/O ports.
Unfortunately, the
.Tn Li INSTALL
kernel may not detect all devices in your system. This may
be because the
.Tn Li INSTALL
kernel only supports the minimum set of devices to install
.Nx
on your system, or it may be that
.Nx
does not have support for the device causing the conflict.
.Pp
For example, suppose your laptop has a
soundblaster device built in; the
.Tn Li INSTALL
kernel has no sound support. The
.Tn PCMCIA No code might allocate your soundblaster's
.Tn IRQ No and I/O ports to
.Tn PCMCIA
devices, causing them not to work, or to lock up the system. This is
especially bad if one of the devices in question is your ethernet
card.
.Pp
As of
.Nx 1.5 ,
the kernel attempts to probe for available interrupts that are
usable by the
.Tn PCIC
.Tn ( PCMCIA
interrupt controller). Assuming that this functions correctly, it
should alleviate interrupt conflicts; however, I/O port conflicts are
still possible.
.Pp
This problem will impact some, but not all, users of
.Tn PCMCIA .
If this problem is affecting you, watch the
.Dq Bq Tn PCMCIA
notes that will appear in this document.
.if r_i386 \{\
.Pp
It can be difficult to distinguish an interrupt conflict from
an I/O space conflict. There are no hard-and-fast rules, but
interrupt conflicts are more likely to lock up the machine,
and I/O space conflicts are more likely to result in misbehavior
(e.g. a network card that cannot send or receive packets).
.Pp
The kernel selects a free interrupt according to a mask of allowable
interrupts, stored in the kernel global variable
.Va pcic_isa_intr_alloc_mask .
This mask is a logical-or of power-of-2s of allowable interrupts:
.(disp
IRQ  Val     IRQ  Val     IRQ  Val      IRQ  Val
  0  0x0001    4  0x0010    8  0x0100    12  0x1000
  1  0x0002    5  0x0020    9  0x0200    13  0x2000
  2  0x0004    6  0x0040   10  0x0400    14  0x4000
  3  0x0008    7  0x0080   11  0x0800    15  0x8000
.disp)
.Pp
For example, 0x0a00 allows both IRQ 9 and IRQ 11. By default,
the
.Tn Li INSTALL
kernel permits all IRQs other than IRQs 5 and 7, so the corresponding
mask is 0xff5f. The
.Tn Li GENERIC
kernel, however, allows all IRQs. (The presumption here
is that IRQ 10 may be assigned to a device that the
.Tn Li GENERIC
kernel
supports, but that the
.Tn Li INSTALL
does not.) Because of support for interrupt probing, it is no
longer necessary to exclude IRQs 3 and 5 explicitly; if they are
in use, they should not be assigned to
.Tn PCMCIA .
.Pp
The kernel selects IO space by assigning cards IO space within a
predefined range.  The range is specified as a base and size,
specified by the kernel global variables
.Va pcic_isa_alloc_iobase
and
.Va pcic_isa_alloc_iosize .
For systems with 12-bit addressing (most systems), the kernel defaults to a
base of 0x400 and a size of 0xbff (a range of 0x400-0xfff).
For systems with 10-bit addressing, the kernel defaults to a
base of 0x300 and a size of 0xff (range of 0x300-0x3ff).
.Pp
Unfortunately, these ranges may conflict with some devices. In the
event of a conflict, try a base of 0x330 with a size of 0x0bf (range
of 0x330-0x3ff).
.Pp
In order to work around this at installation time, you may
boot the
.Tn Li INSTALL
kernel with
.Ic boot Fl d ,
in order to enter
.Xr ddb 4
(the in-kernel debugger), and then use the
.Ic write
command to alter the variable values:
.Pp
.Dl db\*> Ic "write pcic_isa_intr_alloc_mask 0x0a00"
.Dl "pcic_isa_intr_alloc_mask            0xff5f = 0xa00"
.Dl db\*> Ic "write pcic_isa_alloc_iobase 0x330"
.Dl "pcic_isa_alloc_iobase               0x400 = 0x330"
.Dl db\*> Ic "write pcic_isa_alloc_iosize 0x0bf"
.Dl "pcic_isa_alloc_iosize               0xbff = 0xbf"
.Dl db\*> Ic "continue"
.Pp
Note that, since some floppy images may not have symbol information in
the kernel, you may have to consult the matching
.Pa .symbols
file in the
.Pa binary/kernel
directory in the installation tree. Find the pcic_ symbols used above,
look at the hexadecimal value in the first column, and write, for
example (if
.Va pcic_isa_intr_alloc_mask
is equal to c0513e3c):
.Pp
.Dl db\*> Ic "write 0xc0513e3c 0x0a00"
.Pp

After installation, this value can be permanently written to the kernel image
directly with:
.Pp
.Dl # Ic "cp /netbsd /netbsd.bak"
.Dl # Ic "gdb --write /netbsd"
.Dl (gdb) Ic "set pcic_isa_intr_alloc_mask=0x0a00"
.Dl (gdb) Ic "set pcic_isa_alloc_iobase=0x330"
.Dl (gdb) Ic "set pcic_isa_alloc_iosize=0x0bf"
.Dl (gdb) Ic "quit"
.Dl #
.Pp
or you could specify these value when configuring your kernel, e.g.:
.(disp
options PCIC_ISA_INTR_ALLOC_MASK=0x0a00
options PCIC_ISA_ALLOC_IOBASE=0x330
options PCIC_ISA_ALLOC_IOSIZE=0x0bf
.disp)
.Pp
If you can
get your
.Tn PCMCIA
card to work using this hack, you may also ignore the
.Bq Tn PCMCIA
notes later in this document.
.Pp
We hope to provide a more elegant solution to this problem in a future
.Nx
release.
.\} \" r_i386
.\} \" ! \n[macppc]:\[news68k]:\n[pmax]:\n[x68k]
.It
.To 2 General
.Em General
.Pp
The following is a walk-through of the steps you will take while
getting
.Nx
installed on your hard disk.
.Ic sysinst
is a menu driven
installation system that allows for some freedom in doing the
installation. Sometimes, questions will be asked and in many cases
the default answer will be displayed in brackets
.Pq Dq \&[\ ]
after the question. If you wish to stop the installation, you may press
.Key CONTROL-C
at any time, but if you do, you'll have to begin the installation
process again from scratch, by running the 
.Pa /sysinst
program from the command prompt, you do not need to reboot.
.It
.To 2 "Quick install"
.Em Quick install
.Pp
First, let's describe a quick install. The other sections of
this document go into the installation procedure in more
detail, but you may find that you do not need this. If you
want detailed instructions, skip to section 3. This section
describes a basic installation, using a CD-ROM install as
an example.
.Pp
.(bullet
What you need.
.(bullet
The distribution sets (in this example, they are on CD).
.if !r_pmax \{\
.It
.ie r_alpha Two floppy disks.
.el .ie r_i386 Two 1.44 MB 3.5" floppy disks.
.el .ie \n[macppc]:\n[sparc] Some form of bootable media, described above.
.el One 1.44 MB 3.5" floppy.
.\} \" ! r_pmax
.if r_i386 \{\
.It
A PC with a 386 or newer processor.
.\} \" r_i386
.It
A CD-ROM drive
.ie \n[alpha]:\n[i386]:\n[macppc] (SCSI or ATAPI),
.el (SCSI),
a harddisk and a minimum of
.if r_alpha 32 MB
.if r_i386 4 MB
.if r_macppc 8 MB
.if r_news68k 4 MB
.if r_pmax 8 MB
.if r_sparc 4 MB
of memory installed.
.It
The harddisk should have at least
.if r_alpha 200
.if r_i386 70
.if r_macppc 200
.if r_news68k 100
.if r_pmax 200
.if r_sparc 200
+
.Em n
megabytes of
space free, where
.Em n
is the number of megabytes of
main memory in your system. If you wish to install
the X Window System as well, you will need at least
60 MB more.
.bullet)
.if \n[alpha]:\n[i386]:\n[news68k] \{\
.It
Creating the boot floppies.
You can create the floppies needed for installation
under
.Tn MS-DOS
or
.Tn Windows .
Supposing your 1.44 MB floppy
drive is drive A:, and your CD is drive E: do the
following from an
.Tn MS-DOS
command prompt:
.Pp
.Dl Ic "e:"
.Dl Ic "cd \eNetBSD-\*V\ei386\einstallation\emisc"
.Dl Ic "rawrite"
.Pp
When asked for a source filename, answer
.if r_i386 \{\
.Dl Pa \&..\efloppy\eboot1.fs
for the first diskette and
.Dl Pa \&..\efloppy\eboot2.fs
for the second diskette.
.\}
.if r_alpha .Dl Em \&(...alpha installation root) Ns Pa \efloppy\edisk1of2
.if r_news68k .Dl Pa \eNetBSD-\*V\e\*M\einstallation\efloppy\eboot.fs
.Pp
When asked for a destination drive answer
.Sq Ic a .
.It
To create a bootfloppy under
.Nx
or other
.Ul
system, you would type something like:
.Pp
.Dl # Ic "dd if=.../boot1.fs bs=18k of=/dev/rfd0a"
.Pp
.\} \" \n[alpha]:\n[i386]:\[news68k]
.It
The Quick Installation
.(bullet
.ie \n[macppc]:\n[pmax]:\n[sparc] \{\
Boot the system as described above.  You
should be at the
.Ic sysinst
main menu.
.\} \" \n[macppc]:\n[pmax]:\n[sparc]
.el \{\
Insert the
.ie r_i386 first
.ie r_alpha first
boot floppy you just created.
.ie r_i386 Restart
.el Boot
the computer.
.if r_alpha \{\
Type
.Pp
.Dl \&\*>\*>\*> Ic "B DVA0"
.Pp
.\}
.if r_i386 When prompted, insert the second boot floppy.
.if r_news68k \{\
Type
.Pp
.Dl \&NEWS\*> Ic "bo fh"
.Pp
.\}
The main menu will be displayed.
.\} \" ! r_pmax
.(disp
  .***********************************************.
  * NetBSD-1.5.2 Install System                   *
  *                                               *
  *\*>a: Install NetBSD to hard disk                *
  * b: Upgrade NetBSD on a hard disk              *
  * c: Re-install sets or install additional sets *
  * d: Reboot the computer                        *
  * e: Utility menu                               *
  * x: Exit Install System                        *
  .***********************************************.
.disp)
.It
If you wish, you can configure some network settings
immediately by choosing the
.Me Utility menu
and then
.Me Configure network .
It isn't actually required at this point, but
it may be more convenient. Go back to the main menu.
.It
Choose
.Me install .
.It
You will be guided through some steps regarding the
setup of your disk, and the selection of distributed components
to install. When in doubt, refer to the rest of this document for details.
.It
After your disk has been prepared, choose
.Me CD-ROM
as the medium. The default values for the path and device should be ok.
.It
After all the files have been unpacked, go back to
the main menu and select
.ie \n[macppc]:\n[pmax]:\n[sparc] \{\
.Me reboot.
.\}
.el \{\
.Me reboot ,
after you have removed the bootfloppy from the drive.
.\}
.It
.if r_macppc \{\
Once the system reaches the Open Firmware prompt, you will need to type
the correct command to boot from your hard drive.
.\}
.if r_sparc \{\
Once the system reaches the PROM prompt, you will need to type the correct
command to boot from your hard drive.
.\}
.Nx
will now boot. If you haven't already done so in 
.Ic sysinst ,
you should log in as
.Li root ,
and set a password for that account. You are also
advised to edit the file
.Pa /etc/rc.conf
to match your system needs.
.It
Your installation is now complete.
.It
For configuring the X window system, if installed, see the files in
.Pa /usr/X11R6/lib/X11/doc .
.if !\n[macppc]:\n[sparc] \{\
Further information can be found on
.Lk http://www.xfree86.org/ .
.\}
.if \n[macppc] \{\
Further information can be found on
.Lk http://www.netbsd.org/Ports/macppc/x11.html
.\}
.bullet)
.bullet)
.It
.To 2 "Booting NetBSD"
.Em Booting NetBSD
.
.
.if !\n[macppc]:\n[news68k]:\n[pmax]:\n[sparc]:\n[x68k] \{\
.(pcmcia
Unplug your
.Tn PCMCIA
devices, so that they won't be found by
.Nx .
.pcmcia)
.\} \" !\n[macppc]:\n[news68k]:\n[pmax]:\n[sparc]:\n[x68k]
.ie \n[macppc]:\n[pmax]:\n[sparc] \{\
.Pp
Boot the system as described in the previous section.
.Pp
You may want to read the
boot messages, to notice your disk's name and capacity. Its name
will be something like
.Li sd0
.if r_macppc \{\
or
.Li wd0
.\}
and the geometry will be
printed on a line that begins with its name. As mentioned above,
you may need your disk's geometry when creating
.Nx 's
partitions.
You will also need to know the name, to tell
.Ic sysinst
on which disk
to install.
The most important thing to know is that
.if r_macppc \{\
.Li wd0
is
.Nx 's
name for your first IDE disk,
.Li wd1
the second, etc.
.\}
.Li sd0
is your first SCSI disk,
.Li sd1
the second, etc.
.\}
.el \{\
.
.
.Pp
Boot your machine. The boot loader will
start, and will print a countdown and begin booting.
.Pp
If the boot loader messages do not appear in a reasonable
amount of time, you either have a bad boot floppy or a
hardware problem. Try writing the install floppy image to
a different disk, and using that.
.if r_i386 \{\
.Pp
If that doesn't work, try booting after disabling your CPU's
internal and external caches (if any). If it still doesn't
work,
.Nx
probably can't be run on your hardware. This can
probably be considered a bug, so you might want to report it.
If you do, please include as many details about your system
configuration as you can.
.\}
.Pp
It will take a while to load the kernel from the floppy,
probably around a minute or so, then, the kernel boot messages
will be displayed. This may take a little while also, as
.Nx
will be probing your system to discover which hardware devices are
installed.
.if r_i386 \{\
You may want to read the
boot messages, to notice your disk's name and geometry. Its name
will be something like
.Li sd0
or
.Li wd0
and the geometry will be
printed on a line that begins with its name. As mentioned above,
you may need your disk's geometry when creating
.Nx 's
partitions.
You will also need to know the name, to tell
.Ic sysinst
on which disk
to install.
.\}
The most important thing to know is that
.Li wd0
is
.Nx 's
name for your first IDE disk,
.Li wd1
the second, etc.
.Li sd0
is your first SCSI disk,
.Li sd1
the second, etc.
.Pp
Note that once the system has finished booting, you need not
leave the floppy in the disk drive.
.if r_i386 \{\
Earlier version of
the
.Nx
install floppies mounted the floppy as the system's
root partition
.Pq Pa / ,
but the new installation floppies use a
ramdisk file system and are no longer dependent on the floppy
once it has booted.
.\}
.\}
.Pp
Once
.Nx
has booted and printed all the boot messages,
you will be presented with a welcome message and a main menu.
It will also include instructions for using the menus.
.It
.To 2 "Network configuration"
.Em Network configuration
.if !\n[macppc]:\n[news68k]:\n[pmax]:\n[sparc]:\n[x68k] \{\
.(pcmcia
You can skip this section, as you will only get data
from floppy in the first part of the install.
.pcmcia)
.\} \" ! \n[macppc]:\n[news68k]:\n[pmax]:\n[sparc]:\n[x68k]
.Pp
If you will not use network operation during the installation,
but you do want your machine to be configured for networking once
it is installed, you should first go to the 
.Me Utility menu
, and select the
.Me Configure network 
option.
If you only want to temporarily
use networking during the installation, you can specify these
parameters later. If you are not using the Domain Name System (DNS),
you can give an empty response in reply to answers relating to
this.
.if r_macppc \{\
.It
.To 2 "Preparing a disk which will be used for MacOS and NetBSD"
.Em "Preparing a disk which will be used for"
.Tn MacOS
.Em and NetBSD
.Pp
Skip this step if you are installing
.Nx
onto a dedicated drive.
.Pp
Go to the
.Me "Utility Menu" No Ns ,
and select the 
.Me "Run /bin/sh"
option which will give you a shell prompt.  From this shell prompt, you
will do some of the steps that the normal install procedure
runs automatically.  Unfortunately, at the moment, our install tools
aren't smart enough to deal with drives shared with 
.Tn MacOS
and will overwrite important information describing your partitions.
.Pp
You may need to type one of the following commands to get your delete key
to work properly, depending on your keyboard: 
.Dl # Ic "stty erase '^h'"
.Dl # Ic "stty erase '^?'"
.Pp
Type the following command (replacing
.Pa wd0
with the name of your destination hard drive):
.Dl # Ic "disklabel wd0"
.Pp
This will print out the partition info that was generated by Drive
Setup.  Note that, as discussed above in the
.Sx Partitioning your hard drive for NetBSD
section, your 
.Em "A/UX Root"
typically is the first partition
.No ( Ns Em a No Ns )
and your
.Em "A/UX Swap"
typically is the second partition
.No ( Ns Em b No Ns ).
You may also find that your
.Em "A/UX User"
partition is the seventh partition
.No ( Ns Em g No Ns ).
For example:
.(disp
.Dl # Ic "disklabel wd0"
[...]
#        size   offset     fstype   [fsize bsize cpg/sgs]
  a:   426613   837432     4.2BSD        0     0     0   # (Cyl. 1622*- 2449*)
  b:   204800   632632       swap                        # (Cyl. 1226*- 1622*)
  c:  2134305        0     unused        0     0         # (Cyl.    0 - 4136*)
  d:   426616     1216        HFS                        # (Cyl.    2*- 829*)
  e:   204800   427832        HFS                        # (Cyl.  829*- 1226*)
  f:       21  2134284    unknown                        # (Cyl. 4136*- 4136*)
  g:   870239  1264045     4.2BSD        0     0     0   # (Cyl. 2449*- 4136*)
disklabel: boot block size 0
disklabel: super block size 0
.disp)
.Pp
Now, you need to create filesystems on the partitions that 
.Nx
will be using.
.Pp
.Em "Do not modify any partitions labeled"
.Pa HFS No Em or Pa unknown No Ns .
The partitions you will be using have their
.Pa fstype
listed as
.Pa 4.2BSD No Ns .
.Pp
Run the
.Ic newfs
command on the
.Pa 4.2BSD
partitions:
.(disp
.Dl # Ic "newfs /dev/wd0a"
newfs: /dev/sd1a: not a character-special device
Warning: 120 sector(s) in last cylinder unallocated
/dev/sd1a:      426612 sectors in 827 cylinders of 4 tracks, 129 sectors
        208.3MB in 52 cyl groups (16 c/g, 4.03MB/g, 1024 i/g)
super-block backups (for fsck -b #) at:
     32,   8432,  16832,  25232,  33056,  41456,  49856,  58256,  66080,
  74480,  82880,  91280,  99104, 107504, 115904, 124304, 132128, 140528,
 148928, 157328, 165152, 173552, 181952, 190352, 198176, 206576, 214976,
 223376, 231200, 239600, 248000, 256400, 264224, 272624, 281024, 289424,
 297248, 305648, 314048, 322448, 330272, 338672, 347072, 355472, 363296,
 371696, 380096, 388496, 396320, 404720, 413120, 421520,
newfs: ioctl (WDINFO): Invalid argument
newfs: /dev/sd1a: can't rewrite disk label
.disp)
You can ignore the 
.Pa Sq "not a character-special device" , 
.Pa Sq "sector(s) in last cylinder unallocated" ,
.Pa Sq "ioctl (WDINFO): Invalid argument" ,
and
.Pa Sq "can't rewrite disk label"
warnings.
.Pp
Now you need to mount your destination root partition:
.Dl # Ic "mount /dev/wd0a /mnt"
.Pp
Make an 
.Pa fstab
file for your new system (right now, you only really need to include
.Pa / No ,
.Pa /usr No , 
and 
.Pa swap No ),
for example:
.Dl # Ic "mkdir /mnt/etc"
.Dl # Ic "cat \*> /mnt/etc/fstab"
.Dl "/dev/wd0a / ffs rw 1 1"
.Dl "/dev/wd0b none swap sw 0 0"
.Dl "/dev/wd0g /usr ffs rw 1 2"
.Pp
If you mess up while typing, you can press
.Key CONTROL-U
to erase everything on the current line, or
.Key CONTROL-C
to cancel the file creation, so you can start over.
.Pp
Great, now create the mountpoints for the filesystems you listed in the
.Pa fstab No Ns :
.Dl # Ic "mkdir /mnt/usr"
.Pp
Clean up and return to 
.Ic sysinst :
.Dl # Ic "cd /;umount /mnt"
.Dl # Ic exit
.\}
.It
.To 2 "Installation drive selection and parameters"
.Em Installation drive selection and parameters
.Pp
To start the
.if r_macppc \{\
installation onto a dedicated
.Nx
drive,
.\}
.if !r_macppc installation,
select
.Me Install NetBSD to hard disk
from the main menu.
.if r_macppc \{\
To start the installation onto a drive which will
also be used with
.Tn MacOS ,
select
.Me Re-install sets or install additional sets
from the main menu.
.\}
.Pp
The first thing is to identify the disk on which you want to
install
.Nx .
.Ic sysinst
will report a list of disks it finds
and ask you for your selection. Depending on how many disks
are found, you may get a different message. You should see
disk names like
.ie r_pmax \{\
.Li rz0
or
.Li rz1
.\}
.el \{\
.if \n[alpha]:\n[i386]:\n[macppc] \{\
.Li wd0 ,
.Li wd1 ,
.\}
.Li sd0
or
.Li sd1 .
.if r_i386 \{\
.Pp
.Ic sysinst
next tries to figure out the real and BIOS geometry
of your disk. It will present you with the values it found,
if any, and will give you a chance to change them.
.\}
.Pp
.if r_i386 \{\
Next, depending on whether you are using a
.Li wd Ns Ar X
or
.Li sd Ns Ar X
disk,
you will either be asked for the type of disk
.Pq Li wd Ns Ar X
you are
using or you will be asked if you want to specify a fake geometry
for your SCSI disk
.Pq Li sd Ns Ar X .
The types of disk are be
.Tn IDE, ST-506
or
.Tn ESDI .
If you're installing on an
.Tn ST-506
or
.Tn ESDI
drive, you'll be asked if your disk supports automatic sector forwarding.
If you are
.Em sure
that it does, reply affirmatively. Otherwise, the install
program will automatically reserve space for bad144 tables.
.\}
.if r_macppc \{\
If 
.Ic sysinst 
reports 
.Dl "I can not find any hard disk for use by NetBSD"
or the drive you wish to install onto is missing, then you should look at 
the FAQ entry
.Lk http://www.netbsd.org/Ports/macppc/faq.html#nodisk 
.\}
.\}
.It
.To 2 "Partitioning the disk"
.Em Partitioning the disk
.if r_macppc \{\
.Pp
You can skip a few steps, down to 
.Em Sq "Getting the distribution sets" ,
if you are installing onto a drive that will be used with
.Tn MacOS
(i.e. you selected
.Me "Re-install sets or install additional sets"
from the main menu).
.\}
.(bullet
.if !r_macppc \{\
Which portion of the disk to use.
.Pp
You will be asked if you want to use the entire disk or
only part of the disk. If you decide to use the entire disk
for
.Nx ,
it will be checked if there are already other
systems present on the disk, and you will be asked to confirm
whether you want to overwrite these.
.if r_i386 \{\
.Pp
If you want to use the entire disk for
.Nx ,
you can skip
the following section and go to
.Em "Editing the NetBSD disklabel" .
.It
.Em "Editing the Master Boot Record"
.Pp
First, you will be prompted to specify the units of size
that you want to express the sizes of the partitions in.
You can either pick megabytes, cylinders or sectors.
.Pp
After this, you will be presented with the current values
stored in the MBR, and will be given the opportunity to
change, create or delete partitions. For each partition
you can set the type, the start and the size. Setting the type to
.Ic unused
will delete a partition. You can
also mark a partition as active, meaning that this is
the one that the BIOS will start from at boot time.
.Pp
Be sure to mark the partition you want to boot from as active!
.Pp
After you are done editing the MBR, a sanity check
will be done, checking for partitions that overlap.
Depending on the BIOS capabilities of your machine and the
parameters of the
.Nx
partition you have specified, you
may also be asked if you want to install newer bootcode in
your MBR. If you have multiple operating systems on the
disk that you are installing on, you will also be given
the option to install a bootselector, that will allow you
to pick the operating system to start up when your computer
is (re-)started.
.Pp
If everything is ok, you can go on to the next step,
editing the
.Nx
disklabel.
.Pp
.\}
.It
.\} \" !r_macppc
.Em Editing the NetBSD disklabel
.Pp
The partition table of the
.Nx
part of a disk is called a
.Em disklabel .
.if r_macppc \{\
In actuality, 
.Nx*M
uses an Apple Partition Map.  The installer creates something like a real
Apple Partition Map, but it is not compatible with
.Tn MacOS ,
which is one of the reasons why you cannot use this installer to partition
a disk that can be used with
.Tn MacOS .
.Pp
.\}
.if r_sparc \{\
.Nx
disklabels on \*M are compatible with the boot ROMs, and with 
.Tn SunOS
and
.Tn Solaris .
.\}
There are 3 layouts for the
.Nx
part of the disk that you can pick from:
.Ic Standard, Standard with X
and
.Ic Custom .
The first two use a set of default
values (that you can change) suitable for a normal
installation, possibly including X. The last option
lets you specify everything yourself.
.Pp
You will be presented with the current layout of the
.Nx
disklabel, and given a chance to change it.
For each partition, you can set the type, offset and size,
block and fragment size, and the mount point. The type
that
.Nx
uses for normal file storage is called
.Sy 4.2BSD .
A swap partition has a special type called
.Sy swap .
.
.
.ie r_i386 \{\
.
You can also specify a partition as type
.Sy MSDOS .
This is useful if you share the disk with
.Tn MS-DOS
or
.Tn Windows ;
.Nx
is able to access the files on these partitions.
You can use the values from the MBR for the
.Tn MS-DOS
part of the disk to specify the partition of type
.Sy MSDOS
(you don't have to do this now, you can always re-edit
the disklabel to add this once you have installed
.Nx ).
.Pp
.ds usrpart e
.\}
.el .ie r_macppc \{\
.ds usrpart g
.\}
.el \{\
.ds usrpart d
.\}
Some partitions in the disklabel have a fixed purpose.
.(tag 6n -offset indent
.It Li a
Root partition.
.Pq Pa / ,
.It Li b
Swap partition.
.It Li c
.if r_i386 \{\
The
.Nx
portion of the disk.
.It Li d
.\}
The entire disk.
.ie r_macppc \{\
.It Li d-h
.\}
.el \{\
.It Li \*[usrpart]-h
.\}
Available for other use.
Traditionally,
.Li \*[usrpart]
is the partition mounted on
.Pa /usr ,
but this is historical practice and not a fixed value.
.tag)
.
.Pp
You will then be asked to name your disk's disklabel. The
default response is
.Sy mydisk .
For most purposes this will be OK.
If you choose to name it something different, make sure the name
is a single word and contains no special characters. You don't
need to remember this name.
.bullet)
.Pp
.It
.To 2 "Preparing your hard disk"
.Em Preparing your hard disk
.Pp
.Em "You are now at the point of no return".
Nothing has been
written to your disk yet, but if you confirm that you want to
install
.Nx ,
your hard drive will be modified. If you are
sure you want to proceed, enter
.Li yes
at the prompt.
.Pp
The install program will now label your disk and make the file
systems you specified. The file systems will be initialized to
contain
.Nx
bootstrapping binaries and configuration files.
You will see messages on your screen from the various
.Nx
disk preparation tools that are running. There should be no
errors in this section of the installation. If there are,
restart from the beginning of the installation process.
Otherwise, you can continue the installation program
after pressing the return key.
.if r_i386 \{\
.Pp
.(Note
In previous versions of
.Nx ,
the kernel from the
install floppy was copied onto the hard drive in a special
step. In the current install system, the kernel on the floppy is
unsuited to being copied onto the hard drive. Instead, a new set,
.Sy kern ,
has been added which contains a generic kernel to
be unloaded onto the drive. So, you can not boot from your
hard drive yet at this point.
.Note)
.\}
.if r_macppc \{\
.Pp
.(Note
The bootstrapping code installed in this step will
.Em not
boot a machine with Open Firmware 3.  You will still need to have
.Pa ofwboot.xcf
on an HFS or HFS+ partition.
.Note)
.\}
.It
.To 2 "Getting the distribution sets"
.Em Getting the distribution sets
.if r_i386 \{\
.(pcmcia
.
Load a kernel tar file (i.e. the
.Pa kern.tgz
set file)
on to your hard disk, for example by mounting the
hard disk first, copying the
.Pa kern.tgz
file from floppy and unpacking it. Example:
.Pp
.Dl # Ic "mount /dev/wd0a /mnt"
.Dl # Ic "cd /mnt"
.Pp
.D1 Em "repeat the following 3 steps until all kern.* files are there"
.Dl # Ic "mount -t msdos /dev/fd0a /mnt2"
.Dl # Ic "cp /mnt2/kern.* ."
.Dl # Ic "umount /mnt2"
.Dl # Ic "cat kern.* \&| tar zxpvf -"
.Pp
Then halt the machine using the
.Ic halt
command. Power
the machine down, and re-insert all the
.Tn PCMCIA
devices.
Remove any floppy from the floppy drive.
Start the machine up. After booting
.Nx ,
you will
be presented with the main
.Ic sysinst
menu. Choose the
option to re-install sets. Wait for the file system
checks that it will do to finish, and then proceed
as described below.
.pcmcia)
.\}
.Pp
The
.Nx
distribution consists of a number of
.Em sets ,
that come in the form of gzipped tarfiles. A few sets must be
installed for a working system, others are optional. At this
point of the installation, you will be presented with a menu
which enables you to choose from one of the following methods
of installing the sets. Some of these methods will first
load the sets on your hard disk, others will extract the sets
directly.
.Pp
For all these methods, the first step is making the sets
available for extraction, and then do the actual installation.
The sets can be made available in a few different ways. The
following sections describe each of those methods. After
reading the one about the method you will be using, you
can continue to section labeled
.Sq Extracting the distribution sets .
.It
.To 2 "Installation using ftp"
.Em Installation using ftp
.Pp
To be able to install using ftp, you first need to configure
your network setup, if you haven't already at the start of
the install procedure.
.Ic sysinst
will do this for you, asking you
to provide some data, like IP address, hostname, etc. If you
do not have name service set up for the machine that you
are installing on, you can just press
.Key RETURN
in answer to these questions, and DNS will not be used.
.Pp
You will also be asked to specify the host that you want
to transfer the sets from, the directory on that host,
and the account name and password used to log into that
host using ftp. If you did not set up DNS when answering
the questions to configure networking, you will need to
specify an IP address instead of a hostname for the ftp
server.
.Pp
.Ic sysinst
will proceed to transfer all the default set files
from the remote site to your hard disk.
.It
.To 2 "Installation using NFS"
.Em Installation using NFS
.Pp
To be able to install using NFS, you first need to configure
your network setup, if you haven't already at the start of
the install procedure.
.Ic sysinst
will do this for you, asking you
to provide some data, like IP address, hostname, etc. If you
do not have name service set up for the machine that you
are installing on, you can just press
.Key RETURN
in answer to these questions, and DNS will not be used.
.Pp
You will also be asked to specify the host that you want
to transfer the sets from, and the directory on that host
that the files are in. This directory should be mountable
by the machine you are installing on, i.e. correctly
exported to your machine.
.Pp
If you did not set up DNS when answering the questions to
configure networking, you will need to specify an IP address
instead of a hostname for the NFS server.
.It
.To 2 "Installation from CD-ROM"
.Em Installation from CD-ROM
.Pp
When installing from a CD-ROM, you will be asked to specify
the device name for your CD-ROM player
.Pq usually Li cd0 ,
and the directory name on the CD-ROM where the distribution files are.
.Pp
.Ic sysinst
will then check if the files are indeed available
in the specified location, and proceed to the actual
extraction of the sets.
.if r_i386 \{\
.It
.To 2 "Installation from a floppy set"
.Em Installation from a floppy set
.Pp
Because the installation sets are too big to fit on one floppy,
the floppies are expected to be filled with the split set
files. The floppies are expected to be in
.Tn MS-DOS
format. You will be asked for a directory where the sets
should be reassembled. Then you will be prompted to insert
the floppies containing the split sets. This process
will continue until all the sets have been loaded from floppy.
.\}
.It
.To 2 "Installation from an unmounted file system"
.Em Installation from an unmounted file system
.Pp
In order to install from a local file system, you will
need to specify the device that the file system resides
on
.ie r_pmax .Pq for example Li rz1e
.el .Pq for example Li sd1e
the type of the file system,
and the directory on the specified file system where the sets are located.
.Ic sysinst
will then check if it
can indeed access the sets at that location.
.if r_macppc \{\
Remember, 
.Nx*M
doesn't grok HFS or HFS+ partitions
.\}
.It
.To 2 "Installation from a local directory"
.Em Installation from a local directory
.Pp
This option assumes that you have already done some preparation
yourself. The sets should be located in a directory on a
file system that is already accessible.
.Ic sysinst
will ask you
for the name of this directory.
.It
.To 2 "Extracting the distribution sets"
.Em Extracting the distribution sets
.Pp
After the install sets containing the
.Nx
distribution
have been made available, you can either extract all the
sets (a full installation), or only extract sets that
you have selected. In the latter case, you will be shown the
currently selected sets, and given the opportunity to select
the sets you want. Some sets always need to be installed
.Pq Sy kern, base No and Sy etc
they will not be shown in this selection menu.
.Pp
Before extraction begins, you can elect to watch the files being
extracted; the name of each file that is extracted will be shown.
This can slow down the installation process considerably, especially
on machines with slow graphics consoles or serial consoles.
.Pp
.ie r_macppc \{\
If you are installing using the 
.Me "Re-install sets or install additional sets"
option, then you will need to create the device nodes in
.Pa /dev ,
otherwise, 
.\}
.el After all the files have been extracted,
all the necessary device node files will be created.  If you have already
configured networking, you will be asked if you want to
use this configuration for normal operation. If so, these
values will be installed in the network configuration files.
The next menu will allow you to select the time zone that you're in,
to make sure your clock has the right offset from UTC. 
Finally you can set a password for the "root" account, to prevent 
the machine coming up without access restrictions.  
.if r_macppc \{\
.It
.To 2 "Making the device nodes"
.Em Making the device nodes
.Pp
If you are installing using the 
.Me "Re-install sets or install additional sets"
option, then you will need to create the device nodes in
.Pa /dev 
now.  Otherwise, skip this step.
.Pp
Go to the main installation menu, and select
.Me "Utility menu"
and then select the
.Me "Run /bin/sh"
option, which will give you a shell prompt.
You may need to type one of the following commands to get your delete key
to work properly, depending on your keyboard: 
.Dl # Ic "stty erase '^h'"
.Dl # Ic "stty erase '^?'"
.Pp
Type the following command (replacing
.Pa wd0a
with the partition name of your destination root partition):
Now you need to mount your destination root partition:
.Dl # Ic "mount /dev/wd0a /mnt"
.Dl # Ic "cd /mnt/dev"
.Dl # Ic "sh MAKEDEV all"
.Dl # Ic "cd /;umount /mnt"
.Dl # Ic "exit"
.\}
.It
.To 2 "Finalizing your installation"
.Em Finalizing your installation
.Pp
Congratulations, you have successfully installed
.Nx \*V .
.if !r_macppc \{\
You can now reboot the machine, and boot 
.Nx
from harddisk.
.\} \" !r_macppc
.enum)
