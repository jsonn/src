#	$NetBSD: CHANGES-1.6.2,v 1.1.2.50 2003/06/19 02:26:50 grant Exp $

A complete list of changes from NetBSD 1.6.1 to NetBSD 1.6.2:

File						Revision(s)
----						--------

sys/conf/osrelease.sh				patch
share/tmac/doc-common				patch

	Mark this as 1.6.1_STABLE.

sys/dev/ata/ata_wdc.c				1.39
sys/dev/ic/wdcvar.h				1.36
sys/dev/pci/pciide.c				1.191
sys/dev/pci/pciide_pdc202xx_reg.h		1.9

	Make DMA mode works on Promise Ultra66/100 with 48-bit LBA drives.
	Ok'ed by bouyer in tech-kern@netbsd.org.
	[nakayama, ticket #1275]

usr.sbin/etcupdate/etcupdate			1.10

	Use md5 instead of sum (bin/20196).
	[martti, ticket #1146]

sys/dev/pci/if_rtk_pci.c			1.18

	Set RTK_ENABLE flag when it attached. This fixed multicast problem.
	Found by FUKAUMI Naoki <naoki@fukaumi.org>.
	[kanaoka, ticket #1134]

sys/netinet/in.h				1.59

	C++ does not permit static a data member to have the same name as its
	class, so in a C++ environment rename the ip_opts member to Ip_opts as
	observed in several other implementations; from Jon Olsson in
	PR toolchain/19880.
	[kleink, ticket #1119]

etc/services					1.63

	Add ms-sql-{s,m}, currently quite popular in packet filter logs
	worldwide.
	[ross, ticket #1132]

usr.bin/tftp/tftp.c				1.16

	Fix sendto return value check (incomplete change in 1.14).
	Noted by Brian Ginsbach in PR 19842.
	[wiz, ticket #1139]

sys/netiso/clnp_er.c				1.13

	Keep pkthdr when prepending new mbuf in front of a given chain.
	This keeps us from panic()ing in the interface output routine.
	[is, ticket #1295]

sys/kern/init_main.c				1.215
usr.bin/login/login.c				1.72

	Update copyright notice.
	[fair, ticket #1303]

etc/mrouted.conf				1.5
share/man/man4/ntwoc.4				1.4
	Fix typos.
	[keihan, ticket #1135]

sys/dev/scsipi/scsiconf.c			1.199

	Add PQUIRK_NOLUNS entry for "NEC     ", "CD-ROM DRIVE:502".
	Fixes PR kern/18479
	[bouyer, ticket #1140]

sys/dev/pci/pcidevs				1.503
sys/dev/pci/pcidevs.h				regenerate
sys/dev/pci/pcidevs_data.h			regenerate

	Add SiS 651 host bridge.
	[bouyer, ticket #1143]

sys/dev/scsipi/scsiconf.c			1.198

	Remove revision in quirk entry for TOSHIBA XM-4101TASUNSLCD.
	The same drive with a newer revision also fails, so assume all
	revisions are bad until proven otherwise.
	[bouyer, ticket #1155]

sys/kern/kern_malloc.c				1.73
sys/uvm/uvm_amap.c				1.45
sys/uvm/uvm_amap.h				1.18
sys/uvm/uvm_extern.h				1.72
sys/uvm/uvm_km.c				1.58
sys/uvm/uvm_map.c				1.119

	Add a new km flag UVM_KMF_CANFAIL, which causes uvm_km_kmemalloc() to
	return failure if swap is full and there are no free physical pages.
	have malloc() use this flag if M_CANFAIL is passed to it.
	use M_CANFAIL to allow amap_extend() to fail when memory is scarce.
	this should prevent most of the remaining hangs in low-memory
	situations.
	[skrll, ticket #1156]

usr.bin/progress/progress.c			1.7

	Use an even more elaborate wait loop; it turns out we have a
	child before we even start when run from sysinst.
	[ross, ticket #1167]

usr.bin/cdplay/cdplay.c				1.22

	Fix PR 18444 and a few other corner cases in cdplay.c.
	[is, ticket #1172]

sys/arch/mac68k/dev/akbdmap.h			1.4
sys/arch/macppc/dev/akbdmap.h			1.5

Merged mac68k and macppc keayboards, since they are the same. The file
could move to <arch/mac> if one day we create it.

	Added a french keyboard layout.
	Fixed french keymap: option was not mapped correctly, thus making
	impossible to use |{}[] (tested).
	Added jp keymap from PR/15438, and sf, sv, de and uk keymaps from
	OpenBSD. (all untested).
	[manu, ticket #1183]

sys/net/if_ethersubr.c				1.105

	Ignore multicast PPPoE packets ASAP.
	This improves performance a lot on slow machines behind a cable modem.
	Protect it with PPPOE_SERVER as a reminder that this will have to be
	changed if we add PPPoE server code in the kernel one day.
	[aymeric, ticket #1188]

share/misc/style				1.23

	Return value style update (no parentheses)
	[mason, ticket #1191]

lib/libc/citrus/citrus_ctype_template.h		1.15-1.20
lib/libc/citrus/citrus_none.c			1.6-1.7

	mbsrtowcs_priv template:
        	n == 0 is not an error. it's a valid input.
	_citrus_NONE_ctype_mbsrtowcs:
		fix a typo that causes SEGV.
	while i'm here, make them similar each other.
	when s==0, wctomb should initialize its internal state and return if
	encodings have state dependency or not. Fix part of PR 18269.
	In _RESTART_BEGIN macro, don't use external variable directly.
	- add missing _CEI_TO_EI/_TO_CEI.
	- add missing _STATE_NEEDS_EXPLICIT_INIT checks.
	- more comment.
	- add missing _CEI_TO_EI/_TO_CEI.
	- don't use 'cl' before assert it's non NULL.
	- handle s==NULL case of wcrtomb.
	- add a comment about it.
	Fix rest of PR 18269 by wurlitzer.
	[yamt, ticket #1202]

sbin/fdisk/fdisk.c				1.55

	Add partition type 0xaf for Apple HFS.
	[jdarrow, ticket #1205]

sbin/fdisk/fdisk.c				1.56

	Make the -l flage more useful, by actually printing the systype number
	alongside the sysid string (instead of just the array index of the
	struct part_type they are found in).
	Now fdisk -l shows the familiar 169 for NetBSD, 165 for FreeBSD or
	386BSD or old NetBSD, and other possibly-familiar (131 for Linux
	native,	015 for Ext. Partition - LBA) values in with their correct
	numbers.
	[jdarrow, ticket #1206]

sys/uvm/uvm_bio.c				1.27

	For PMAP_CACHE_VIVT platforms, make UBC_RELEASE_UNMAP evaluate to TRUE,
	and add a comment explaining why.
	[thorpej, ticket #1207]

usr.sbin/rtadvd/rtadvd.c			1.27-1.28

	Add missing ND option length validation.  from kame
	correct use of sizeof
	[itojun, ticket #1212]

share/misc/style				1.23

	Return value style update (no parentheses)
	[mason, ticket #1191]

sys/dev/pci/if_sip.c				1.78

	Add a work-around for the "short cable problem" that some DP83815
	revisions have, as discussed on the soekris-tech mailing list a
	while ago, whereby one can experience excessive recieve erros when
	using < 30m cables.  The patch detects overflow in a DSP filter
	parameter, and corrects it by writing a known good value.
	[thorpej, ticket #1228]

crypto/dist/ssh/auth.c				1.18

	Add missing
		hp = strtok(NULL, ",");
	to end of while loop which parses "host.allow" from login.conf(5).
	Otherwise, sshd(8) would just infinite loop unless there was a
	(positive or negative) match in the first word of the "host.allow"
	list...
	[lukem, ticket #1231]

libexec/lfs_cleanerd/cleanerd.c			1.40

	For -b, use ssize instead of segshift.
	Segshift is invalid for v2 filesystems.
	[toshii, ticket #1232]

usr.bin/mail/popen.c				1.15

	Fix a bug introduced by Christos Zoulas in version 1.4.
	He accidently moved the call to block the SIGCHLD to the wrong side of
	the call to findchild().
	Caused a coredump in one in every N thousand invocations of mail,
	which I have been hunting for literally years.
	Fixes PR 19696 from Mason Loring Bliss, too.
	[perry, ticket #1236]

share/man/man8/man8.amiga/boot.8		1.8
share/man/man8/man8.amiga/installboot.8		1.19

	Fix typos reported by Igor Sobrado (PR port-amiga/20950).
	[is, ticket #1238]

sys/uvm/uvm.h					1.32

	Protect "struct uvm" with _KERNEL.
	[cjep, ticket #1240]

sys/netinet6/in6_pcb.c				1.53

	Include opt_inet.h -- found by David Laight
	[itojun, ticket #1241]

etc/rc.d/bootconf.sh				1.7

	Variable substitution happens at trap installation time, not at trap
	execution time - so it used to print "Using default configuration of
	/etc/passwd".
	[is, ticket #1242]

bin/csh/csh.1					1.37

	Additional text & formatting for the csh "limit" command;
	hopefully this satisfies PR 11658
	[fair, ticket #1243]

libexec/talkd/talkd.c				1.16

	verify strvis() buffer length is enough.  make sure string termination
	before use.  remove extra ntohs() which is not needed.  from Charles
	Blundell
	[itojun, ticket #1001]

sys/dev/scsipi/ses.c				1.19-1.20

	The Double-Semi-Colon Police.

	kern/20231- pass the correct argument (arg_addr) on thru to
	scsipi_do_ioctl, not the locally dereferenced fetch.
	[mjacob, ticket #1162]

sys/dev/pci/agp.c				1.26

	Don't match a PCI graphics card in a system which supports an AGP.
	Patch supplied by Quentin Garnier in PR kern/19256.
	[tron, ticket #1181]

sys/sys/agpio.h					1.2

	From FreeBSD: Fix an off-by-bit error in the AGP_MODE_[GS]ET_RATE()
	macros.

	This fixes PR kern/20480 by Quentin Garnier.
	[tron, ticket #1182]

include/vis.h					1.13

	this needs <sys/types.h>
	[klienk, ticket #1210]

usr.bin/menuc/menuc.1				1.12

	Replace some \n with \en for correct display. Closes PR 18539.
	[manu, ticket #1226]

sys/dev/pci/if_bge.c				1.38

	Don't print a kernel message like "bge0: gigabit link up" when a
	Gigabit link is detected. No other ethernet driver does this and this
	driver doesn't do it for other modes.
	[tron, ticket #1230]

lib/libcurses/curses_private.h			1.30 (via patch)
lib/libcurses/getch.c				1.40 (via patch)
lib/libcurses/screen.c				1.13 (via patch)
lib/libcurses/tty.c				1.32 (via patch)

	Keep the cr->nl translation state in a separate variable, so that we
	can do the translation ourselves (if the tty didn't do it for us).
	Add debugging to track functions that change tty state.
	[jdc, ticket #1244]

usr.bin/chpass/Makefile				1.13

	Build custom getpwent.o only if USE_YP==no. Otherwise, chpass will not
	get the current passwd entry from NIS. Problem reported by Stephen M.
	Jone on tech-net.
	[bouyer, ticket #1245]

sys/dev/pci/if_bge.c				1.34
sys/dev/pci/if_bgereg.h				1.7

	FreeBSD fix for problems reported (to FreeBSD) with 16-bit accesses
	to 32-bit device registers. Add (untested) NetBSD fix for big-endian
	hosts.  From FreeBSD versions:
		if_bge.c:	1.26 and 1.27
		if_bgereg.h: 1.12

	FreeBSD (MFC) comment:

	MFC:  Avoid 16-bit accesses to device memory.  Use volatile where
	appropriate in referencing device memory.  Parenthesize BGE_HOSTADDR
	define properly.
	[tron, ticket #1249]

sys/dev/pci/if_bge.c				1.35
sys/dev/pci/if_bgereg.h				1.8

	Commit the FreeBSD alternative of a private patch to check NIC internal
	ram for using TBI, versus MII/GMII.

	FreeBSD commit log and versions:
	   Obtain the media type from the shared memory and only use the eeprom
	   as a fallback.

	   if_bge.c:	rev 1.30
	   if_bgereg.h:	rev 1.13

	Thanks to Paul Saab @mu.org.
	[tron, ticket #1250]

usr.bin/window/wwiomux.c			1.8

	Fix a bug where window(1) would (appear to) miss a character when two
	characters are typed fast one after the other (<10 ms).
	The visual effect under vi(1) was even more impressive. ;-)
	This bug was actually introduced inadvertantly in 1995 in rev 1.4.
	[aymeric, ticket #1252]

lib/libkvm/kvm.c				1.65.4.2

	Set the close-on-exec bit on all file descriptors we open. Inspired
	by a FreeBSD security advisory.
	[david, ticket #1255]

sys/dev/pci/if_wm.c				1.36

	Pullup short mbuf in wm_tx_cksum() instead of dropping it which fixes
	PR kern/21190 by myself. Jason R. Thorpe code reviewed the changes.
	[tron, ticket #1256]

sys/netinet/ip_icmp.c				1.73

	Clear hardware checksum flags before reusing a mbuf for an ICMP reply
	as suggested by Enami Tsugutomo. This fixes PR kern/21203 by myself.
	[tron, ticket #1260]

sys/arch/amiga/dev/grf_et.c			1.20-1.21

	iszthreepa() takes a physical address, not a virtual address.
	This fixes PR 19175, reported and heavily debugged by Pawel
	Chwalowski.
 
	fix fatal typo
	[is, ticket #1266]

share/man/man4/scc.4				1.3-1.5

	Add MAKEDEV(8) to the SEE ALSO list.
	Clean up nroff problems.

	Change the serial port file names in the FILES section to ttyB0,
	etc. to match current reality, per PR 19572

	Add some paragraph breaks to make the text more readable, and to
	more clearly separate the topics covered.

	Sprinkle Tn macros liberally. Update the man page date.

	Gaaaaaah! I should have double checked that pmax had been changed
	to match alpha, and they're different - alpha: ttyB0, pmax: ttya

	So, change the FILES section again to differentiate between alpha
	and pmax, plus add a clear statement in the first paragraph as to
	which computers listed are supported by which port.

	Hopefully this will properly answer PR 19752
	[fair, ticket #1271]

sbin/dump/rcache.c				1.20

	The sysctl returning the amount of memory in the system returns "int",
	which is silly.  Luckily, it really does return the correct result if
	interpreted as an unsigned int.  This change lets dump work on 32-bit
	systems that have more than 2GB of RAM.
	[rafal, ticket #1272]

sys/dev/wscons/wsemul_vt100.c			1.13 and 1.24 (via patch)
sys/dev/wscons/wsemul_vt100var.h		1.7

	fix crash due to wrong argument in the (almost useless)
	DECRQUPSS escape sequence

	PR/17738: Matthias Drochner, PR/21230: Onno van der Linden: vt100
	wscons crashes restoring cursor. Fixed by adding a flag as suggested.
	[drochner, ticket #1277]

sys/dev/pci/pcidevs				1.511-1.512 (via patch)
sys/dev/pci/pcidevs.h				Regenerate
sys/dev/pci/pcidevs_data.h			Regenerate
sys/dev/pci/pciide.c				1.182 (via patch)
sys/dev/pci/pciide_sis_reg.h			1.10 (via patch)
sys/dev/pci/pciidevar.h				1.9 (via patch)

	Rework SiS support: more controller supported (up to Ultra/133) and
	better support for the older ones.

	Information for this work extracted from Soeren Schmidt's FreeBSD
	driver.

	Sync with the latest diff I made available, and also include changes
	from kern/18015 which is much better than the hack I've done.
	[bouyer, ticket #1234]

share/misc/na.phone				1.16-1.18 (via patch)

	Fix comment about format.
	Fixes PR misc/17722 from David MacKenzie.

	Add new numbers, remove some stars, and mildly sort it so that it's
	actually in numeric order.

	re-gen with new machinery. Finally up-to-date.
	[jhawk, #1189]

share/man/man8/man8.sun2/boot.8			1.1-1.4 (new)
share/man/man8/man8.sun2/Makefile		1.2
src/distrib/sets/lists/man/mi			1.573

	Added a boot(8) man page for sun2.

	Use more mdoc macros; comment out reference to non-existing crash(8)
	from SEE ALSO.

	Added a SYNOPSIS section, added content about boot device
	selection, and added the man page to the set lists.

	New sentence, new line; drop trailing spaces.
	[fredette, ticket #1278]

crypto/dist/kame/racoon/crypto_openssl.c	1.6

	fix "round up to 8" code.  from kame
	[itojun, ticket #1270]

sys/arch/newsmips/newsmips/cpu_cons.c		1.7

	Fix unexpected fallthrough in switch statement.

	This should fix boot failure of the INSTALL kernel
	on news3400 with serial console.
	[tsutsui, ticket #1276]

sys/netinet6/ip6_mroute.c			1.47

	don't try to forward multicast packet to mif that went away.
	[itojun, ticket #1317]

sys/arch/mac68k/dev/if_mc.c			1.21
sys/arch/macppc/dev/am79c950.c			1.14

	Don't bring down mc(4) interfaces when they underflow.
	Fixes PR#12088. [bjh21, ticket #1314]

sys/netinet/tcp_input.c				1.168

	Inherit IPV6_V6ONLY from listening socket. Fixes PR#21713.
	[itojun, ticket #1304]

sys/dev/pci/if_ste.c				1.17

	Add a missed htole32() for DMA txdescs.
	[tsutsui, ticket #1315]

sys/dev/ic/i82557.c				1.74 (via patch)

	Fix of possible null pointer dereferences.
	[yamt, ticket #1296]

etc/services					1.65

	Add "kamanda" 10081/udp for Amanda with Kerberos. Fixes PR#21756.
	[fair, ticket #1312]

sys/net/route.h					1.32
sys/net/route.c					1.55
sys/netinet/ip_input.c				1.163 (via patch)

	Remove all entries in rt timer queue on ip_mtudisc change, instead
	of destroying the queue.
	[itojun, ticket #984]

sbin/mount_union/mount_union.8			1.14

	Add some mdoc macros. Add text from PR 13878, modified.
	[fair, ticket #1283]

usr.bin/du/du.c					1.21 (via patch)

	If no files are specified on the command line, put { ".", NULL } in
	it's own little array instead of writing over argv.  Fixes problems
	where du shows up in ps as ". fts_open `%s'" (and shorter or longer
	combinations of that depending in what argc was).
	[simonb, ticket #1284]

distrib/sets/lists/base/shl.mi			1.211 (via patch)
lib/libc/arch/powerpc/net/Makefile.inc		1.2
lib/libc/shlib_version				1.131 (via patch)

	Build {h,n}to{n,h}{l,s}() into object code; addresses PR
	port-macppc/21541 from Tsuyoshi MOMOSE.

	Bump to libc.so.12.83.2, due to addition of {h,n}to{n,h}{l,s}() on
	PowerPC.
	[kleink, ticket #1288]

dist/dhcp/common/discover.c			1.6

	Skip !IFF_BROADCAST interfaces (such as strip). After discussion
	with Ted Lemon leave in checks for IFF_LOOPBACK and IFF_POINTTOPOINT
	in case an OS incorrectly marks them with IFF_BROADCAST.
	Patch submitted back to dhcp-server@isc.org
	[abs, ticket #1292]

distrib/notes/macppc/prep			1.37

	Fix broken link. Pointed out by Ray Phillips on www@.
	http://asu.info.apple.com/ has been replaced by
	http://www.info.apple.com/support/downloads.html.
	[yyamano, ticket #1297]

lib/libc/stdio/vfscanf.c			1.34

	Fix handing of -ve hexadecimal numbers in the %i format.  Fixes
	PR lib/21691.  Patch from Simon Burge.
	[thorpej, ticket #1298]

sys/sys/shm.h					1.33

	Include <sys/unistd.h> for the definition of _SC_PAGESIZE, which is
	required for run-time retrieval of SHMLBA.  While this does make
	visible additional symbols which are not in the underscore-prefixed
	implementation-reserved namespace, its impact should be negligible (and
	most applications supposedly include <unistd.h> as well), and there is
	verify strvis() buffer length is enough.  make sure string termination
	before use.  remove extra ntohs() which is not needed.  from Charles
	Blundell
	[kleink, ticket #1301]

distrib/notes/macppc/hardware			1.31-1.34

	- Add mention of experimental MP support in -current
	- Apple's official name for recent iBooks is actually (16VRAM).
	- D'oh -- PowerComputing PowerBase models are actually Open Firmware
	  2.0.

	- misc small typos and wording cleanup
	- PowerBase is actually Open Firmware 2.0.x
	- add iBook (16VRAM) and iBook (Summer2002) as supported models
	- mention next release of NetBSD will support multiple CPUs
	- mention that some L3 caches on CPU upgrades may not be enabled by
	  default
	- PowerMacintosh G4 (FW 800) model is reported to work with 1.6.1
	- macppc uses gem driver instead of gm ethernet driver now
	- macppc uses tlp driver instead of de ethernet driver now
	- AirPort Extreme is unsupported
	- full wscons capabilities not supported (virtual terminals and color)
	- keyboard problems with iMac and B&W G3 seem to have been cleared up
	[mbw, ticket #1305]

distrib/notes/macppc/install			1.26

	misc small typos and wording cleanup
	fix links to newly updated Partitioning HOW-TO and mention use of pdisk
	can't view files on official ISO image or floppy from Open Firmware
	keyboard problems with iMac and B&W G3 seem to have been cleared up
	[mbw, ticket #1306]

distrib/notes/macppc/prep			1.38

	misc small typos and wording cleanup
	fix links to newly updated Partitioning HOW-TO
	OF 3 firmware update 4.1.7, mention that it's not much of a problem
	anymore
	point to ZTerm home page
	redo partitioning section
	update now that there's a pair of boot floppies
	change MS-DOS floppy section to be Zip disk
	[mbw, ticket #1307]

distrib/notes/common/contents			1.90

	mention macppc has two floppies now
	[mbw, ticket #1308]

distrib/notes/common/netboot			1.15

	detab a few lines, and in general try to make it better for 80 column
	printout
	[mbw, ticket #1310]

distrib/notes/common/sysinst			1.63

	fix a macppc TOC heading to be a little shorter
	[mbw, ticket #1311]

sys/netatalk/at_control.c			1.8

	Make "ifconfig $interface" display phase 1 addresses also.
	[is, ticket #1313]

sys/arch/sparc64/sparc64/intr.c			1.43

	Fix yet another inverted comparison.
	[martin, ticket #1318]
