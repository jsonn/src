# $NetBSD: CHANGES-5.3,v 1.1.2.22 2013/07/29 02:20:07 msaitoh Exp $

A complete list of changes from the NetBSD 5.2 release to the NetBSD 5.3
release:

doc/LAST_MINUTE					patched by hand
doc/README.files				patched by hand
gnu/usr.bin/groff/tmac/mdoc.local		patched by hand
sys/sys/param.h					patched by hand

	Welcome to 5.2_STABLE.
	[riz]

sys/fs/smbfs/smbfs_node.c			1.48, 1.49 via patch
sys/fs/smbfs/smbfs_node.h			1.13 via patch
sys/fs/smbfs/smbfs_vnops.c			1.83, 1.84 via patch

	Various fixes for smbfs:

	- Implement NGONE to fix caching issue described in PR kern/25070.
	  Mostly taken from FreeBSD r125637.
	- Revert revision 1.70 of smbfs_vnops.c to fix setattr to opened
	  direcotry.  In case of SMB_CAP_NT_SMBS, NOPEN is set after
	  smbfs_smb_ntcreatex() call.  If NOPEN is set in front, it will
	  immediately return by condition at do_open label.
	- In smbfs_close(), call smbfs_smb_close() and drop NOPEN bit in
	  the case of direcotry.  Otherwise smbfs_rmdir() fails when the
	  directory was opened.
	- Remove redundant vput() before vgone().
	- Avoid unnecessary mutex_exit() in smbfs_node_alloc().
	- Set NGONE bit to from-name vnode to invalidate the smbnode cache.
	[nakayama, ticket #1823]

sys/fs/smbfs/smbfs_smb.c			1.44
sys/fs/smbfs/smbfs_subr.c			1.16
sys/fs/smbfs/smbfs_subr.h			1.21
sys/fs/smbfs/smbfs_vnops.c			1.85
sys/netsmb/smb.h				1.20

	Improve smbfs timestamp handling.
	Don't round timestamp to 2 seconds resolution if the server
	supports the CAP_INFOLEVEL_PASSTHRU capability.
	[nakayama, ticket #1824]

sys/netsmb/smb_iod.c				1.31 - 1.35
sys/netsmb/smb_rq.c				1.32

	Do not call callout_stop() unless the structure was previoulsy
	initialised for a non null timeout.
	Do initialise the callout when fetching a new request structure from
	the pool, not when starting the timer. Likewise, destroy the callout
	when giving back the item to the pool.
	Send data for as long as there is new data available.  Otherwise
	there was a danger of smb_iod_recvall() blocking, hence releasing
	the kernel lock, new data creeping into the queue, and a wakeup
	being missed (well, there's still a race, but since it's theoretical
	enough for me to never have encountered it, I'll rather solve it
	by periodic wakeups).
	defensive programming: wake up iod thread once a second "just in case"
	add comment to previous stating periodic wakeups can be nuked
	once smb is mpsafe.
	[nakayama, ticket #1825]

sys/dev/lockstat.c				1.16

	Fix off by one.
	[msaitoh, ticket #1826]

sys/dev/raidframe/rf_driver.c			1.131

	Fix off by one read.
	[msaitoh, ticket #1827]

sys/external/isc/atheros_hal/dist/ah_eeprom_v14.c		patch

	Fix off by one read.
	[msaitoh, ticket #1828]

sys/compat/netbsd32/netbsd32_fs.c		1.64

	Fix inverted error check.
	[matt, ticket #1829]

sys/dev/usb/ubsa_common.c			1.9

	Fix off by one read error.
	[msaitoh, ticket #1830]

sys/external/bsd/drm/dist/shared-core/i915_suspend.c 1.6

	Fix wrong reference to dev_priv->saveSWF1. It was clearly wrong.
	[msaitoh, ticket #1831]

sbin/sysctl/sysctl.c				1.149 via patch

	Add missing free() in error path.
	[msaitoh, ticket #1832]

usr.bin/netstat/bpf.c				1.11

	Fix memory leak.
	[msaitoh, ticket #1833]

sys/arch/i386/conf/XEN2_DOMU:			patch
sys/arch/amd64/conf/XEN3_DOMU:			patch

	Add drvctl to Xen DOMU kernels
	[sborrill, ticket #1834]

sbin/fsck_ffs/pass1.c				1.50

	Show pass1 SIGINFO output on stderr like other passes, not on stdout.
	[riastradh, ticket #1837]

etc/namedb/root.cache				1.17

	D.ROOT-SERVERS.NET changes IPv4 address.
	[taca, ticket #1839]

gnu/dist/grep/lib/getopt.c			1.2
gnu/dist/grep/lib/regex.c			1.2
gnu/dist/grep/src/ansi2knr.c			1.2
gnu/dist/grep/src/dfa.c				1.3
gnu/dist/grep/src/grep.c			1.14
gnu/dist/grep/src/search.c			1.4

	Change several int variables to size_t, ssize_t, or ptrdiff_t.
	This should fix the bug described in CVE-2012-5667 when an input
	line is so long that its length cannot be stored in an int
	variable.

	[apb, ticket #1838]

lib/librefuse/refuse.c				1.96 via patch

	FUSE seems to allow short writes without errors but PUFFS doesn't. Work
	around this by returning ENOSPC in case of a short write to avoid
	protocol errors. This change is based on problem analysis provided by
	Antti Kantee.
	This fixes PR lib/45129 by myself.
	[tron, ticket #1836]

sys/dev/bluetooth/bthidev.c			1.23, 1.24 via patch
sys/dev/bluetooth/btmagic.c			1.4, 1.5 via patch
usr.sbin/btdevctl/btdevctl.8			1.8 via patch

	when no link-mode is specified, explicitly set a mode of (int)0
	otherwise l2cap_setmode() will fail during connection setup
	for bthidev.c, this fixes a problem with Microsoft Wedge Touch
	mouse (which may not be able to authenticate)
	for btmagic.c, include this fix in case somebody tries that
	related to PR/47286
	[plunky, ticket #1835]

sys/arch/arm/arm32/cpu.c			1.89

	print cpu model string correctly
	[msaitoh, ticket #1841]

sys/dev/pci/pcidevs			1.969 via patch
sys/dev/pci/pcidevs.h			regen
sys/dev/pci/pcidevs_data.h		regen
sys/dev/pci/viaide.c			1.58

	Add VT8237S Integrated SATA Controller support (PR#47452).
	[msaitoh, ticket #1842]

sys/external/bsd/ipf/netinet/ip_fil_netbsd.c	1.4 via patch

	Fix off-by-one read error.
	[msaitoh, ticket #1840]

doc/3RDPARTY					patch
share/zoneinfo/africa				patch
share/zoneinfo/antarctica			patch
share/zoneinfo/asia				patch
share/zoneinfo/australasia			patch
share/zoneinfo/europe				patch
share/zoneinfo/northamerica			patch
share/zoneinfo/southamerica			patch
share/zoneinfo/zone.tab				patch
distrib/sets/lists/base/mi			patch

	Merge tzdata2013a and tzdata2013b from
	ftp://ftp.iana.org/tz/releases/tzdata2013a.tar.gz and
	ftp://ftp.iana.org/tz/releases/tzdata2013b.tar.gz .
	Important changes from tzdata2012j to tzdata2013a:
	 Chile's 2013 rules, and we guess rules for 2014 and later, will be
	 the same as 2012, namely Apr Sun>=23 03:00 UTC to
	 Sep Sun>=2 04:00 UTC.
	 New Zones Asia/Khandyga, Asia/Ust-Nera, Europe/Busingen.
	 Many changes affect historical time stamps before 1940.
	Important changes from tzdata2013a to tzdata2013b:
	 Haiti uses US daylight-saving rules this year, and presumably
	 future years.
	 Paraguay will end DST on March 24 this year.
	 Morocco does not observe DST during Ramadan;
	 try to predict Ramadan in Morocco as best we can. 
	[apb, ticket #1854]

share/zoneinfo/antarctica			patch
share/zoneinfo/asia				patch
share/zoneinfo/australasia			patch
share/zoneinfo/southamerica			patch
share/zoneinfo/zone.tab				patch

	Merge tzdata2013c from
	ftp://ftp.iana.org/tz/releases/tzdata2013c.tar.gz
	[apb, ticket #1860]

sys/dev/pci/pcireg.h			1.69
sys/dev/pci/ppb.c			1.44-1.45

	Support PCI Express 2.0.
	Print version and device/port type information
	[msaitoh, ticket #1844]

distrib/utils/sysinst/menus.mi		1.35, 1.43

	Some v6 dns server are outdated, so replace them with google's
	public servers.
	[msaitoh, ticket #1846]

xsrc/external/mitMesaLib/dist/src/glx/x11/XF86dri.c	patch
xsrc/external/mitlibFS/dist/src/FSOpenServ.c		patch
xsrc/external/mitlibX11/dist/modules/im/ximcp/imLcPrs.c	patch
xsrc/external/mitlibX11/dist/modules/im/ximcp/imTrX.c	patch
xsrc/external/mitlibX11/dist/src/AllCells.c		patch
xsrc/external/mitlibX11/dist/src/Font.c			patch
xsrc/external/mitlibX11/dist/src/FontInfo.c		patch
xsrc/external/mitlibX11/dist/src/FontNames.c		patch
xsrc/external/mitlibX11/dist/src/GetFPath.c		patch
xsrc/external/mitlibX11/dist/src/GetImage.c		patch
xsrc/external/mitlibX11/dist/src/GetMoEv.c		patch
xsrc/external/mitlibX11/dist/src/GetPntMap.c		patch
xsrc/external/mitlibX11/dist/src/GetProp.c		patch
xsrc/external/mitlibX11/dist/src/LiHosts.c		patch
xsrc/external/mitlibX11/dist/src/ListExt.c		patch
xsrc/external/mitlibX11/dist/src/ModMap.c		patch
xsrc/external/mitlibX11/dist/src/Xrm.c			patch
xsrc/external/mitlibX11/dist/src/xcms/cmsColNm.c	patch
xsrc/external/mitlibX11/dist/src/xkb/XKBExtDev.c	patch
xsrc/external/mitlibX11/dist/src/xkb/XKBGeom.c		patch
xsrc/external/mitlibX11/dist/src/xkb/XKBGetMap.c	patch
xsrc/external/mitlibX11/dist/src/xkb/XKBNames.c		patch
xsrc/external/mitlibXcursor/dist/src/file.c		patch
xsrc/external/mitlibXext/dist/src/XEVI.c		patch
xsrc/external/mitlibXext/dist/src/XShape.c		patch
xsrc/external/mitlibXext/dist/src/XSync.c		patch
xsrc/external/mitlibXext/dist/src/Xcup.c		patch
xsrc/external/mitlibXext/dist/src/Xdbe.c		patch
xsrc/external/mitlibXfixes/dist/src/Cursor.c		patch
xsrc/external/mitlibXi/dist/src/XGMotion.c		patch
xsrc/external/mitlibXi/dist/src/XGetBMap.c		patch
xsrc/external/mitlibXi/dist/src/XGetDCtl.c		patch
xsrc/external/mitlibXi/dist/src/XGetDProp.c		patch
xsrc/external/mitlibXi/dist/src/XGetFCtl.c		patch
xsrc/external/mitlibXi/dist/src/XGetProp.c		patch
xsrc/external/mitlibXi/dist/src/XListDev.c		patch
xsrc/external/mitlibXi/dist/src/XQueryDv.c		patch
xsrc/external/mitlibXinerama/dist/src/Xinerama.c	patch
xsrc/external/mitlibXrandr/dist/src/XrrProperty.c	patch
xsrc/external/mitlibXrender/dist/src/Filter.c		patch
xsrc/external/mitlibXrender/dist/src/Xrender.c		patch
xsrc/external/mitlibXres/dist/src/XRes.c		patch
xsrc/external/mitlibXt/dist/src/ResConfig.c		patch
xsrc/external/mitlibXt/dist/src/Selection.c		patch
xsrc/external/mitlibXv/dist/src/Xv.c			patch
xsrc/external/mitlibXvMC/dist/src/XvMC.c		patch
xsrc/external/mitlibXxf86dga/dist/src/XF86DGA2.c	patch
xsrc/external/mitlibXxf86vm/dist/src/XF86VMode.c	patch

	Fix protocol handling issues in X client libraries.
	[mrg, ticket #1865]

external/mit/xorg/lib/fontconfig/src/Makefile		patch
external/mit/xorg/lib/libX11/Makefile.libx11		patch
external/mit/xorg/lib/libXi/Makefile			patch

	Silence gcc 4.1 warnings from ticket #1865.
	[mrg, ticket #1866]

etc/MAKEDEV.tmpl				1.161

	The console major number is not always 0.
	[apb, ticket #1848]

etc/rc.d/wpa_supplicant				1.4

	Make custom "reload" target work. Before this fix it would have tried
	to send a HUP signal to "wpa_supplicant" instead.
	[tron, ticket #1849]

bin/sh/expand.c					1.88
bin/sh/expand.h					1.19

	Fix the expansion of "$(foo-$bar}" so that IFS isn't applied when
	expanding $bar.	Noted by Greg Troxel on tech-userlevel running some
	'git' tests. Should fix PR bin/47361.
	[gdt, ticket #1851]

sys/dev/fss.c					1.84

	Don't crash when running multiple dump -X. PR#47514.
	[gdt, ticket #1853]

sys/arch/amd64/conf/XEN3_DOMU			patch
sys/arch/i386/conf/Attic/XEN2_DOMU		patch

	Add wedge support in DOMU kernels.
	[sborrill, ticket #1858]

sys/dev/pci/if_vioif.c				1.4

	Fix a typo, and remove an unused member.
	This should fix the problem that recent Qemu dies during configuring
	a vioif. Fixes PR#47780.
	[minoura, ticket #1861]

dist/nvi/common/conv.c				1.7 via patch

	Don't truncate files on character conversions without warning
	and a chance for recovery.
	[christos, ticket #1845]

sys/netinet/ip_icmp.c				1.130
sys/netinet/ip_icmp.h				patch

	Add missing codes to ICMP handling.  PR#47693.
	[fair, ticket #1855]

sys/arch/vax/boot/xxboot/start.S		1.5
sys/sys/bootblock.h				1.55
sys/sys/disklabel.h				1.113
usr.sbin/installboot/arch/vax.c			1.14-1.17

	fix VAX bootblocks and installboot for VAX 780 and similar machines
	(booting via VMB.EXE).
	Don't include host's disklabel.h.
	[martin, ticket #1856]
sys/arch/x86/include/mtrr.h			1.5
sys/arch/x86/include/specialreg.h		1.55
sys/arch/x86/x86/mtrr_i686.c			1.25

	Increase MTRR_I686_NVAR_MAX from 8 to 16. Avoids
	"FIXME: more than 8 MTRRs (10)" message on booting Thinkpad W520 and
	similar. While here replace a magic number with MTRR_I686_NVAR_MAX * 2
	[msaitoh, ticket #1847]

sys/dev/pci/if_wm.c			1.201, 1.203-1.204, 1.207-1.212, 1.215,
					1.217-1.218, 1.220-1.223, 1.228,
					1.232-245 via patch
sys/dev/pci/if_wmreg.h			1.40-1.45, 1.47-1.48 via patch
sys/dev/pci/if_wmvar.h			1.11-1.14 via patch
sys/dev/pci/pcidevs			1.1074, 1.1077, 1.1117 via patch
sys/dev/pci/pcidevs.h			regen
sys/dev/pci/pcidevs_data.h		regen
sys/dev/mii/igphyreg.h			1.6 via patch
sys/dev/mii/ihphy.c			1.1-1.2 via patch
sys/dev/mii/ihphyreg.h			1.1 via patch
sys/dev/mii/inbmphyreg.h		1.3 via patch
sys/dev/mii/files.mii			1.47 via patch
sys/dev/mii/miidevs			1.97 and 1.100 via patch
sys/dev/mii/miidevs.h			regen
sys/dev/mii/miidevs_data.h		regen
sys/arch/i386/conf/ALL			1.280 via patch
sys/arch/i386/conf/GENERIC		1.1001 via patch
sys/arch/i386/conf/INSTALL_FLOPPY	1.11 via patch
sys/arch/i386/conf/XEN2_DOM0		patch
sys/arch/amd64/conf/GENERIC		1.293 via patch
sys/arch/amd64/conf/XEN3_DOM0		1.61 via patch
share/man/man4/wm.4			1.21-1.24 via patch

	Apply almost all fixes and improvements from netbsd-6 except for
	the rev. 1.196's iqdrops' change.

	- Add the detach code.
	- Add code for WOL, ASF, IPMI and Intel AMT. WOL is disabled by default
	- Add Yet another workaround for ICH8.
	- 82576 is dual port, so check the FUNCID and increment the
	  MAC address for the 2nd port.
	- Fix the names of 82577L[MC] LAN controllers (for mobile).
	- Fix CTRL_EXT_SWDPIN() and CTRL_EXT_SWDPIO() macros. The bit order
	  of the SW definable pin is not 6543 but 3654!!!
	- Rewrite the code to read MAC address from eeprom.
	- Add 82580 support.
	- 82571 quirk. Only 82571 shares port 0 of EEMNGCTL_CFGDONE.
	- The document says that the TDH register must be set after
	  TCL.EN is set on 82575 and newer devices.
	- Fix some register names. No functional change.
	- Omit U+00AE "REGISTERED SIGN" in a product name due to its
	  non-ASCII nature.
	- Stop wm(4) from needlessly resetting when you add or delete a vlan(4).
	- Fix MAC address check on 8257[156] and 80003 case. Some cards have
	  non 0xffff pointer but those don't use alternative MAC address
	  in reality. So we check whether the broadcast bit is set or not
	  like Intel's e1000 driver.
	  Fixes PR kern/44072 reported by Jean-Yves Moulin.
	- Add PCH2(and 82579) support. Fixes PR#46487
	- Add yet another 82567V support.
	- Add ICH10+HANKSVILL support.
	- Add support Intel I350 Ethernet.
	- Make vlan and all ip/ip6 checksum offload work for the I350.
	- Fix compile error with  WM_DEBUG.
	- Fix a bug that PHY isn't set to low-power mode on PCH and PCH2.
	- Add WM_DEBUG_NVM. If WM_DEBUG_NVM is enabled, dump the FLASH ROM data.
	- Skip 64bit BAR correctly.
	- Fix RAL_TABSIZE for ICH8, 82576, 82580 and I350.
	- Use 82580(and I350) specific PHY read/write functions. Fixes PR#47542.
	- Style fix. Fix typo in comment. Fix comments. Add comments.
	[msaitoh, ticket #1850]

sys/kern/kern_drvctl.c				1.34

	Fix memory leak on the following cases when device attached or detached:
	  - No one open drvctl.
	  - kmem_alloc() failed in devmon_insert().

	[msaitoh, ticket #1859]

share/man/man4/options.4			1.420

	Fix typo
	[msaitoh, ticket #1862]

sys/netinet6/ip6_flow.c				1.21

	Clear mbuf's csum_flags in ip6flow_fastforward(). Fixes PR#47849.
	[msaitoh, ticket #1864]

distrib/sets/lists/man/mi			1.1411
share/man/man4/Makefile				1.593
share/man/man4/gpio.4				1.24
share/man/man4/ptcd.4				1.1, 1.3, 1.4
sys/arch/i386/conf/ALL				1.348
sys/arch/i386/conf/files.i386			1.369
sys/dev/isa/ptcd.c				1.1

	Add ptcd(4), a device driver for the cash drawer port found on
	Protech PS3100 point of sale terminals.  It controls the cash drawer
	using a gpio(4) device that attaches at ptcd0.
	[mbalmer, ticket #1863]

external/bsd/bind/dist/lib/dns/rdata/generic/keydata_65533.c	patch

	Fix for bind CVE-2013-4854.
	[spz, ticket #1871]
