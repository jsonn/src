# $NetBSD: CHANGES-5.0.2,v 1.1.2.25 2009/11/14 09:49:16 sborrill Exp $

A complete list of changes from the NetBSD 5.0.1 release to the NetBSD 5.0.2
release:

gnu/usr.bin/groff/tmac/mdoc.local		patched by hand
sys/sys/param.h					patched by hand

	Welcome to 5.0.1_PATCH.
	[snj]

lib/libevent/Makefile				1.6 via patch

	Problems have been observed with GCC 4 and strict-aliasing in
	the libevent code.  Add -fno-strict-aliasing to work around this.
	[tls, ticket #876]

doc/CHANGES					patch
doc/3RDPARTY					patch
external/bsd/dhcpcd/dist/client.c		patch
external/bsd/dhcpcd/dist/config.h		patch
external/bsd/dhcpcd/dist/configure.c		patch
external/bsd/dhcpcd/dist/dhcp.c			patch
external/bsd/dhcpcd/dist/dhcp.h			patch
external/bsd/dhcpcd/dist/dhcpcd-run-hooks.8.in	patch
external/bsd/dhcpcd/dist/dhcpcd.8.in		patch
external/bsd/dhcpcd/dist/dhcpcd.c		patch
external/bsd/dhcpcd/dist/dhcpcd.conf.5.in	patch
external/bsd/dhcpcd/dist/net.c			patch
external/bsd/dhcpcd/dist/net.h			patch
external/bsd/dhcpcd/dist/signals.c		patch

	Update dhcpcd to 4.0.14.
	[roy, ticket #880]

sys/ufs/ufs/ufs_quota.c				1.63, 1.65

	Add missing mutex_destroy() before pool_cache_put(). Prevents
	a "Mutex error: lockdebug_alloc: already initialized" panic.
	[bouyer, ticket #898]

sys/netipsec/ipsec.c				1.46

	Add a missing splx() call. Fixes PR kern/41701.
	[jakllsch, ticket #884]

sys/dev/pci/twa.c				1.32

	Disable completely bogus DIAGNOSTIC check.
	[bouyer, ticket #886]

bin/pax/options.c				1.105
dist/nawk/maketab.c				1.12
dist/nawk/proctab.c				1.11
dist/nawk/proto.h				1.9
dist/nawk/run.c					1.29
usr.bin/ctags/C.c				1.19
usr.bin/ctags/ctags.h				1.9
usr.bin/ctags/fortran.c				1.11
usr.bin/ctags/lisp.c				1.11
usr.bin/ctags/print.c				1.10
usr.bin/ctags/yacc.c				1.12
usr.bin/gencat/gencat.c				1.30

	Rename internal getline() function to get_line() so it does
	not conflict with -current's getline(3) libc function.
	[roy, ticket #885]

sbin/ifconfig/parse.c				1.14

	Both carp.c and vlan.c expect for a keyword with a KW_T_STR-type
	value to put a prop_string_t into the environment, but the
	keyword parser put a prop_data_t into the environment, instead.
	That broke the -vlanif and -carpdev keywords and defied developer
	expectations.  Let's put a prop_string_t into the environment.
	[dyoung, ticket #878]

sbin/ifconfig/vlan.c				1.13

	Don't require a "vlan" argument with "-vlanif".  "ifconfig vlan0
	-vlanif" now works as one would expect.
	[dyoung, ticket #879]

sbin/dkctl/dkctl.8				1.19, 1.20
sbin/dkctl/dkctl.c				1.18

	In dkctl(8), list the partition types addwedge understands, so
	you don't need to utsl to find out what strings to use.  Fixes
	PR 37252

	Make dkctl conform to its man page and print the device name on
	addwedge when the addition was successful (as well as indicating
	success).
	[spz, ticket #887]

sys/dev/if_ndis/if_ndis.c			1.28
sys/dev/if_ndis/if_ndis_pci.c			1.16

	Make ndis actually compile.  Fixes PR/39034.
	[dsl, ticket #888]

sys/kern/kern_resource.c			1.152

	PR/41489: setpriority(2) returns EACCES instead of EPERM.
	Per discussion on the PR's audit trail, put back original checks
	for now.
	[dsl, ticket #893]

lib/libc/sys/semctl.2				1.18
lib/libc/sys/shmctl.2				1.20

	Fix pastos. PR 41605.
	[dholland, ticket #894]

sys/arch/amd64/amd64/trap.c			1.58
sys/arch/hp300/include/cpu.h			1.60
sys/arch/news68k/include/cpu.h			1.34
sys/arch/powerpc/powerpc/trap.c			1.130 via patch

	amd64: T_ASTFLT|T_USER: check for LP_OWEUPC in l_lpflag, not
	l_flag.  Also, flag unset was on p->p_flag.  Luckily, it did
	not corrupt the p_flag, because we don't have LW_ flag matching
	LP_OWEUPC.

	Fix a few more l_pflag and LP_OWEUPC confusions.
	[rmind, ticket #897]

sys/dev/ic/i82365.c				1.108

	Fix pcic kthread creation timing.  Fixes PR kern/41791 and
	PR port-hpcmips/41164.
	[jun, ticket #899]

lib/libc/gdtoa/gdtoaimp.h			1.7

	Change Kmax so we allocate enough freelist entries to handle
	large field numbers.
	[christos, ticket #913]

sys/arch/x86/pci/ichlpcib.c			1.18

	Fix watchdog code:
	- the timer bound constants are in tick, so convert period to
	tick before checking it against the bounds
	- for ICH5 or older, fix code that would have always written a 0
	period to the register.
	[bouyer, ticket #912]

lib/libc/gen/fts.c				1.38

	Avoid possible integer overflow on really deep dirs,
	and subsequent collateral damage.
	Received from OpenBSD via US-CERT as VU #590371.
	[christos, ticket #915]

sys/arch/macppc/dev/pbms.c			1.8

	- Use device_private() (led to immediate crash during attach)
	- While there, fix the aspect ratio of the trackpad on the
	geyser2 model
	[aymeric, ticket #916]

sbin/tunefs/tunefs.c				1.40

	Fix pasto: UFS_WAPBL_FLAGS_CREATE_LOG is "create-log" not
	"clear-log"
	[bouyer, ticket #917]

sys/arch/hpcmips/vr/vr.c			1.54

	Fix PR port-hpcmips/41863, Missing "}".
	[jun, ticket #918]

usr.bin/mixerctl/mixerctl.1			1.24

	Fix markup.
	[joerg, ticket #919]

share/man/man4/bcsp.4				1.4, 1.5
share/man/man4/btuart.4				1.7-1.9

	Fix some small nits and mention how to configure the tty line
	as a bluetooth device
	[plunky, ticket #926]

etc/ssh/ssh_known_hosts				1.5

	Update and add some TNF ssh keys.
	[spz, ticket #930]

lib/libc/stdio/vfwprintf.c			1.16

	If the current locale doesn't define the 'thousands' grouping info
	then use sane defaults (',' every 3 digits).
	Fixes PR/40714
	[dsl, ticket #902]

sbin/fsck_ext2fs/main.c				1.33

	Ignore the "-P" option as intended to make this work with e.g.
	"fsck_flags=-pP" in "/etc/rc.conf".
	Patch supplied by Pierre Pronchery in PR bin/41490.
	[tron, ticket #914]

usr.bin/newsyslog/newsyslog.c			1.59

	Reset ziptype on each line. Failure to do this caused any log file to
	be compressed if it was listed after a line using Z or J flag.
	[manu, ticket #925]

usr.bin/netstat/netstat.1			1.52

	Fix typo
	[dholland, ticket #933]

usr.bin/chflags/chflags.1			1.18

	Add some markup to improve clarity.
	[dholland, ticket #934]

sys/dev/acpi/pckbc_acpi.c			1.32

	PR# port-i386/39671: panic while booting with an acpi kernel on a
	790GX board
	If the firmware describes duplicate keyboard controller nodes,
	don't panic when the driver fails to map registers.
	[jmcneill, ticket #939]

sys/dev/ic/mfi.c				1.28 via patch

	Fix command list corruption seen on heavy I/O load on the mfi
	driver(4).
	[bouyer, ticket #931]

dist/nvi/regex/regcomp.c			1.5

	Fix PR bin/41781, the pattern /\$/ doesn't match a dollar sign
	anymore by default.
	[tnozaki, ticket #938]

xsrc/external/mit/expat/dist/lib/xmltok_impl.c	1.2
xsrc/xfree/xc/extras/expat/lib/xmltok_impl.c		1.2

	Apply revisions 1.14 and 1.15 from expat CVS to fix SA36425.
	[snj, ticket #951]

sys/dev/pad/padvol.c				1.4

	Catch up to audio(4) device_t/softc split.
	[jmcneill, ticket #945]

sys/dev/rnd.c					1.74

	rnd_wakeup_readers() uses rndpool_mtx for its own consistency
	management, so it cannot be called with the mutex held.  There
	is no consistency requirement to synchronize over the whole
	add-and-wakeup operation, as if data is consumed in the window
	the mutex is locked, wakeups will simply be skipped.

	Fix from Juho Salminen in PR kern/42020.
	[pooka, ticket #948]

sys/arch/alpha/alpha/cpu.c			1.86

	There's now some per-cpu initialization that occurs before the
	secondary cpus are told to begin running.  Since the seconedary
	cpus weren't being added to the cpu_info list until then, that
	initialization wasn't being done and resulted in crashes on the
	secondary cpus.  Add the secondary cpus to the cpu_info_list
	after they've been started (but waiting to be told to start
	running).  This fixes the problem specifically stated in PR
	port-alpha/41106.  MP alphas will now at least boot and begin
	running, but will eventually crash in various ways later.
	[mhitch, ticket #949]

sys/arch/alpha/alpha/pmap.c			1.241

	Now that secondary cpus are added the cpu_info list earlier,
	attempt to send pmap tlb shootdowns to them cause the shootdown
	job queue to fill up, but since the cpus aren't running yet, no
	IPIs get sent.  When the job queue is full, the bit mask of cpus
	to send the IPI to is not set and no shootdown IPI ever gets sent
	after the cpu is marked running.  Always set the cpumask even when
	the queue is full.
	[mhitch, ticket #953]

sys/arch/vax/vax/clock.c			1.51

	Keep track of the previous ICR value and hardclock_ticks to ensure
	the 32 bit counter doesn't go backwards.  Also, the ICR runs from
	-10000 to -1, so adjust the value when reading it.  Now mfpr works
	quite nicely on a 4000/90.
	[mhitch, ticket #955]

bin/pax/Makefile				1.38
bin/pax/ar_io.c					1.49
tools/compat/configure				1.69
tools/compat/configure.ac			1.69

	Do not require sys/mtio.h for a tools build of pax.
	[apb, ticket #1020]

distrib/cdrom/hide-hfs.lst			1.5
distrib/mac68k/stand/Makefile			1.6
distrib/notes/common/main			1.451
distrib/sets/Makefile				1.70
distrib/sets/makesrctars			1.37
distrib/sets/makesums				1.16
share/man/man7/release.7			1.31 via patch

	Sync release(7) with reality.
	Only generate SHA512 and MD5 checksums for releases.
	[snj, ticket #1066]

sys/kern/tty.c					1.234

	Check for zero length read here - and return zero. Without
	this there is a simple local-user panic in ureadc().
	[dsl, ticket #1087]

usr.bin/printf/printf.c				1.34

	Avoid segv on "printf '%*********s' 666".
	[christos, ticket #1091]

etc/Makefile					1.365
etc/audit-packages.conf				removed

	Retire audit-packages.conf, it was obsoleted by the
	merge of pkg_install-20090201.
	[joerg, ticket #784]

sys/arch/alpha/alpha/pmap.c			1.243

	IPI interrupts occur above IPL_VM, so using IPL_VM in for the
	tlb shootdown queue mutex doesn't work very well.  Change to
	IPL_SCHED [IPL_CLOCK] to block IPI interrupts while the cpu is
	mucking with the shootdown queue.
	[mhitch, ticket #1073]

external/bsd/pkg_install/dist/add/add.h			1.1.1.3 - 1.1.1.5
external/bsd/pkg_install/dist/add/main.c		1.1.1.4 - 1.1.1.6
external/bsd/pkg_install/dist/add/perform.c		1.1.1.10 - 1.1.1.12
external/bsd/pkg_install/dist/add/pkg_add.1		1.1.1.8
external/bsd/pkg_install/dist/admin/audit.c		1.1.1.6
external/bsd/pkg_install/dist/admin/main.c		1.1.1.8 - 1.1.1.11
external/bsd/pkg_install/dist/admin/pkg_admin.1		1.1.1.9
external/bsd/pkg_install/dist/create/build.c		1.1.1.6
external/bsd/pkg_install/dist/create/create.h		1.1.1.4
external/bsd/pkg_install/dist/create/main.c		1.1.1.5
external/bsd/pkg_install/dist/create/perform.c		1.1.1.4
external/bsd/pkg_install/dist/delete/pkg_delete.1	1.1.1.5 - 1.1.1.6
external/bsd/pkg_install/dist/delete/pkg_delete.c	1.1.1.5
external/bsd/pkg_install/dist/info/info.h		1.1.1.4 - 1.1.1.5
external/bsd/pkg_install/dist/info/main.c		1.1.1.6 - 1.1.1.7
external/bsd/pkg_install/dist/info/perform.c		1.1.1.11
external/bsd/pkg_install/dist/info/show.c		1.1.1.7
external/bsd/pkg_install/dist/lib/config.h.in		1.1.1.4
external/bsd/pkg_install/dist/lib/conflicts.c		1.1.1.3
external/bsd/pkg_install/dist/lib/decompress.c		1.1.1.3
external/bsd/pkg_install/dist/lib/fexec.c		1.1.1.3
external/bsd/pkg_install/dist/lib/file.c		1.1.1.4 - 1.1.1.5
external/bsd/pkg_install/dist/lib/gpgsig.c		1.1.1.2
external/bsd/pkg_install/dist/lib/iterate.c		1.1.1.3
external/bsd/pkg_install/dist/lib/lib.h			1.1.1.8 - 1.1.1.9
external/bsd/pkg_install/dist/lib/license.c		1.1.1.5
external/bsd/pkg_install/dist/lib/parse-config.c	1.1.1.5 - 1.1.1.7
external/bsd/pkg_install/dist/lib/pkcs7.c		1.1.1.4
external/bsd/pkg_install/dist/lib/pkg_install.conf.5.in	1.1.1.6 - 1.1.1.8
external/bsd/pkg_install/dist/lib/pkg_io.c		1.1.1.7
external/bsd/pkg_install/dist/lib/pkg_signature.c	1.1.1.6
external/bsd/pkg_install/dist/lib/pkgdb.c		1.1.1.4 - 1.1.1.5
external/bsd/pkg_install/dist/lib/plist.c		1.1.1.5
external/bsd/pkg_install/dist/lib/remove.c		1.1.1.2
external/bsd/pkg_install/dist/lib/var.c			1.1.1.3
external/bsd/pkg_install/dist/lib/version.h		1.1.1.18 - 1.1.1.21

	Update to pkg_install-20091008:
	- pkg_add: add support to check license conditions before installation
	- pkg_delete: add -k option to skip over preserve packages.
	- WARNS=4 clean, fix some potential uses of uninitialized variables
	- Add a new command for pkg_admin: findbest. It takes one or more
	  patterns and searches for the best match in PKG_PATH, just like
	  pkg_add would.
	  It prints the URLs of the best match for each pattern to stdout.
	- Rewrite the config file parser to read the file only once.
	- Fix a bug in pkg_add's -P handling. For dependencies the pkgdb path
	  was computed incorrectly and included destdir more than once.
	- Fix the ACTIVE_FTP option to actually set the "a" flag and not the
	  old "p" flag.
	- restore pkg_add -f functionality for missing dependencies (PR 42001)
	- pkg_admin rebuild should count packages correctly (he@), also
	  count @pkgdir   
	- fix gpg-sign-package syntax in pkg_admin(1)
	- change default URL for pkg-vulnerabilities to use HTTP
	- Fix German accent
	- Don't dereference a null pointer for pkg_admin add
	[joerg, ticket #1075]

sys/arch/sparc64/include/userret.h		1.9
sys/arch/sparc64/sparc64/trap.c			1.158

	Merge want_ast check in userret() into trap handler, and
	repeat preempt() call while want_resched is true.  While
	there remove unnecessary #if 1. This should fix a performance
	degradation of disk I/O on heavy load.
	[nakayama, ticket #1103]

sys/arch/alpha/alpha/machdep.c			1.321

	Ensures the cpu running the shutdown waits for the correct
	cpus to halt and thus stop the machine hanging at shutdown.
	[mhitch, ticket #1118]

sys/arch/amd64/include/Makefile.inc		1.1

	Build kernel modules with -mno-red-zone like kernel is built.
	This fixes frequent panics in amd64 zfs module, plus other
	reported problems.
	[cube, ticket #1140]

sys/netinet6/ip6_forward.c			1.67

	Clear cksum flags before any further processing like
	ip_forward does. Many drivers set the UDP/TCP v4 flags even
	for v6 traffic and if the packet is encapsulated with gif,
	the IPv6 header would get corrupted by ip_output.
	[joerg, ticket #1139]

