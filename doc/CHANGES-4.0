#       $NetBSD: CHANGES-4.0,v 1.1.4.19 2006/12/21 14:26:59 tron Exp $

A complete list of changes from the initial NetBSD 4.0 branch on
1 December 2006 until the 4.0 release:

gnu/usr.bin/groff/tmac/mdoc.local		patched by hand
sys/sys/param.h					patched by hand

	Welcome to 4.0_BETA2

sys/lib/libsa/dosfs.c				1.11

	make bootxx_msdos fit in 8k again; thanks, __internal_memset_, for
	spilling registers all over the place.
	[dogcow, ticket #240]

sys/uvm/uvm_swap.c				1.114

	We are required to hold uvm.swap_data_lock here too.
	[elad, ticket #241]

sys/dev/pci/ahcisata.c				1.2

	Don't call the done callback twice if a special action is waiting on
	the queue. Don't forget to free the xfer in the normal bio path.
	[bouyer, ticket #242]

usr.bin/msgc/msg_sys.def			1.37

	Eliminate an alloca(3) use. This is required for USE_SSP builds to
	complete.
	[tls, ticket #243]

sys/conf/Makefile.kern.inc			1.95

	Add arch/xen/i386/gdt.c to list of kernel files that do variable-size
	allocations on the stack. This allocation could potentially be quite
	large -- I am not sure how to best fix that.
	Fixes USE_SSP i386 build.sh failure.
	[tls, ticket #244]

share/man/man9/kauth.9				1.37
sys/dev/i2o/dpti.c				1.31
sys/dev/i2o/iop.c				1.62
sys/dev/ic/dpt.c				1.55
sys/dev/ic/icp_ioctl.c				1.14
sys/dev/ic/mlx.c				1.49
sys/dev/pci/amr.c				1.43
sys/dev/pci/mly.c				1.33
sys/dev/pci/twe.c				1.82
sys/dev/tc/stic.c				1.37
sys/kern/kern_auth.c				1.33
sys/secmodel/bsd44/secmodel_bsd44_securelevel.c	1.19
sys/sys/kauth.h					1.25

	Change kauth(9) KPI for kauth_authorize_device_passthru() to add
	another argument, u_long, serving as a bit-mask of generic requests
	for the passthru request.
	[elad, ticket #247]

doc/CHANGES					patch

	Add entry for etherip(4).
	[rpaulo, ticket #249]

sys/miscfs/procfs/procfs_vnops.c		1.141

	Make procfs work again for non-root users.
	[elad, ticket #248]

gnu/usr.bin/gdb53/libiberty/Makefile		1.5

	Fix SSP build for the poor archs that have not converted yet.
	[tls, ticket #250]

gnu/usr.bin/gdb53/gdb/Makefile			1.8

	Allow to build NetBSD-amd64 with USE_SSP set.
	[tls, ticket #251]

sys/ufs/ffs/ffs_snapshot.c			1.38

	Prevent kernel panics when creating snapshots on filesystems which
	uses quotas. This fixes PR kern/35121.
	[hannken, ticket #252]

share/man/man9/scheduler.9			1.4

	Update to describe current API (only), and not duplicate that can be
	found elsewhere. (And which will appear in the NetBSD Internals Guide
	soonish).
	Submitted by Daniel Sieger <dsieger@TechFak.Uni-Bielefeld.DE>,
	OK'd by martin@ and  yamt@
	[hubertf, ticket #253]

sys/arch/sparc/conf/GENERIC			1.197
sys/arch/sparc64/conf/GENERIC			1.80

	sparc64: don't enable PaX MPROTECT by default for now.
	sparc: add commented out 'FILEASSOC'.
	[elad, ticket #254]

usr.sbin/veriexecgen/veriexecgen.8		1.9
usr.sbin/veriexecgen/veriexecgen.c		1.9

	More verbose error messages in veriexecgen(8).
	Also introduce a new -W flag, which will warn the user about the
	error, but will still continue processing - it treats errors as
	warnings, and allows a signatures file to be built.
	[elad, ticket #255]

distrib/utils/sysinst/net.c			1.114

	Ensure the generated ifconfig.* file has proper media selection.
	[martin, ticket #256]

sys/kern/kern_resource.c			1.109

	Fix PR/35021: allow root cannot get/set rlimit information of user
	processes through sysctl again.
	[elad, ticket #257]

distrib/hp700/ramdisk/dot.profile		1.2
distrib/hp700/ramdisk/dot.profile		1.2
distrib/hp700/ramdisk/list			1.4
distrib/hp700/ramdisk/list			1.4
etc/etc.hp700/MAKEDEV.conf			1.3
etc/etc.hp700/MAKEDEV.conf			1.3
sys/arch/hp700/conf/majors.hp700		1.21
sys/arch/hp700/conf/majors.hp700		1.21

	Various installation fixes for hp700.
	[skrll, ticket #258]

sys/netinet/ip_etherip.c			1.2
sys/netinet6/ip6_etherip.c			1.2

	Allow etherip support to be compiled on ports other than i386.
	[jdc, ticket #259]

share/man/man9/uvm.9				1.79
sys/uvm/uvm_extern.h				1.123
sys/uvm/uvm_swap.c				1.115

	Back out uvm_is_swap_device().
	[elad, ticket #261]

sys/arch/i386/i386/powernow_k7.c		1.21

	Add another model that needs to be added into the quirk table.
	[xtraeme, ticket #262]

lib/libc/arch/sparc64/gen/resumecontext.c	1.3

	getcontext(2)/setcontext(2) fixes for sparc64.
	[martin, ticket #263]

lib/libc/arch/arm/gen/resumecontext.c		1.3
lib/libc/arch/hppa/gen/resumecontext.c		1.2
lib/libc/arch/mips/gen/resumecontext.c		1.3
lib/libc/arch/powerpc/gen/resumecontext.c	1.3
lib/libc/arch/powerpc64/gen/resumecontext.c	1.2
lib/libc/arch/sh3/gen/resumecontext.c		1.3
lib/libc/arch/sh5/gen/resumecontext.c		1.2
lib/libc/arch/sparc/gen/resumecontext.c		1.3
lib/libc/arch/vax/gen/resumecontext.c		1.2

	getcontext(2)/setcontext(2) fixes for arm, hppa, mips, powerpc,
	powerpc64, sh3,  sh5, sparc, vax.
	[martin, ticket #264]

sbin/veriexecctl/veriexecctl_parse.y		1.20

	fixes a bug where entries with multiple flags only counted the
	last flag.
	[elad, ticket #265]

doc/3RDPARTY					1.489
share/zoneinfo/zone.tab				1.1.1.27 via patch
share/zoneinfo/australasia			1.12

	tz{code,data}2006p out; tzdata2006p imported.
	[kleink, ticket #260]

sys/arch/xen/x86/consinit.c			1.7

	Remove extra ) causing compile failure when CONS_OVERRIDE is defined.
	From Hideo Masuda in PR port-xen/35217.
	[bouyer, ticket #266]

sys/dev/pci/pcidevs				1.857
sys/dev/pci/pcidevs.h				regen
sys/dev/pci/pcidevs_data.h			regen

	Add another PCI ID for Dell PERC 5.
	[bouyer, ticket #267]

share/man/man9/KASSERT.9			1.3

	Fix description to match the code.
	[pooka, ticket #268]

sys/miscfs/deadfs/dead_vnops.c			1.43

	Teach deadfs about vm object locking for getpages. This avoids
	errors resulting from situations where we take a page fault for a
	vnode which has been converted a deadfs vnode.
	[pooka, ticket #269]

sys/dev/sbus/stp4020.c				1.49

	Fix build of STP4020 SBus/PCMCIA driver.
	[jdc, ticket #270]

gnu/dist/gcc4/gcc/config/pa/pa.md		1.2

	Fix PA code generatation on 64bit hosts.
	[skrll, ticket #271]

sys/arch/mac68k/dev/if_mc.c			1.28
sys/arch/mac68k/dev/if_mcvar.h			1.12
sys/arch/mac68k/obio/if_mc_obio.c		1.16

	Convert DMA memory allocation to bus_dmamem_alloc.
	[martin, ticket #272]

lib/libc/arch/m68k/gen/resumecontext.S		1.4

	Fix regression tests in "regress/lib/libc/context" for m68k based
	NetBSD ports.
	[martin, ticket #273]

sys/kern/kern_verifiedexec.c			1.80

	entry-type is uint8.
	[elad, ticket #274]

sys/kern/kern_verifiedexec.c			1.81

	Call veriexec_table_delete() in the cases where we won't be failing the
	unmount request.  PR#35252.
	[elad, ticket #275]

usr.bin/cdplay/cdplay.c				1.35

	Take into account the 150 frame start offset time when computing the
	duration of a track.
	[chuck, ticket #276]

sys/netbt/l2cap_signal.c			1.3

	Do not use the output buffer to store data unless we mean it to go
	in the packet, as there is a problem with overwriting information
	while we still need it (opt->length in particular) which causes
	connections to fail.
	[plunky, ticket #277]

sys/dev/pci/eso.c				1.46-1.47

	Un-break clock selection after -Wsign-compare cleanup in rev. 1.43;
	from Stephen Ma in PR kern/35220.
	[kleink, ticket #278]

share/dict/web2					1.15

	Remove an accidentally duplicated word. This also fixes regression
	tests in "regress/lib/libc/db regression".
	[martin, ticket #279]

sys/net/if_fddisubr.c				1.64
sys/net/if_llc.h				1.17
sys/netiso/clnp_input.c				1.32,1.34

	Fix iso(4) over FDDI.
	[is, ticket #280]

usr.bin/column/column.c				1.16

	Stop column(1) from generating an infinite stream of NUL characters.
	This could cause "/etc/security" to fill up "/tmp" during the
	nightly security check.
	[jdc, ticket #281]

sys/arch/alpha/conf/GENERIC			1.302-1.305
sys/arch/alpha/conf/INSTALL			1.91-1.92

	Add the following network devices:
	- pcn at pci
	- wm at pci
	- makphy at mii
	- rgephy at mii
	- rlphy at mii
	and reduce diffs between GENERIC and INSTALL.
	[tsutsui, ticket #282]

share/man/man4/re.4				1.11
sys/dev/ic/rtl8169.c				1.74

	Fix and reenable HW VLAN tagging on re(4):
	- clear re_vlanctl in DMA descriptors before starting TX and RX
	  to avoid stale tags
	- use bswap16() rather than be16toh() or htons() on VLAN tag access
	  since we already use htole32()

	Closes PR kern/32643 and also fixes HW VLAN tagging on big endian
	machines.

	[tsutsui, ticket #283]

distrib/utils/sysinst/arch/i386/msg.md.de	1.9
distrib/utils/sysinst/arch/i386/msg.md.en	1.51
distrib/utils/sysinst/arch/i386/msg.md.es	1.4
distrib/utils/sysinst/arch/i386/msg.md.fr	1.41
distrib/utils/sysinst/arch/i386/msg.md.pl	1.24

	Update message strings to match reordered kernels after TINY ones got
	killed.  Fixes PR/35264
	[dsl, ticket #284]

usr.bin/make/cond.c				1.36
usr.bin/make/main.c				1.138-1.139
usr.bin/make/make.h				1.65
usr.bin/make/parse.c				1.121-1.124
usr.bin/make/targ.c				1.46

	performance improvements and bug fixes for make(1)
	[dsl, ticket #285]

sys/arch/mips/mips/pmap.c			1.169

	Fixes panic running regress/sys/kern/umount on MIPS platforms
	reported by Martin Husemann.
	[simonb, ticket #289]

sys/conf/Makefile.kern.inc			1.97

	use -fstack-protector instead of -fstack-protector-all since this breaks
	on amd64 (it works on sparc64).
	[tls, ticket #290]

sys/conf/Makefile.kern.inc			1.98

	Fix for SSP enabled Xen kernels
	[tls, ticket #291]

share/man/man9/veriexec.9			1.10

	Markup fix - forgot 'Fn'.
	[elad, ticket #292]

sys/netinet6/ipsec.c				1.114

	do not compare ipv6 ipsec tunnel addresses against uninitialized data.
	Fixes PR kern/34734
	[mlelstv, ticket #293]

distrib/sets/lists/man/mi			1.958
share/man/man4/Makefile				1.416
share/man/man4/mfi.4				1.1-1.2
sys/arch/amd64/conf/GENERIC			1.122
sys/arch/amd64/conf/INSTALL			1.61
sys/arch/i386/conf/ALL				1.75
sys/arch/i386/conf/GENERIC			1.802
sys/arch/i386/conf/INSTALL			1.298
sys/arch/i386/conf/XEN2_DOM0			1.19
sys/conf/files					1.821
sys/dev/ic/mfi.c				1.1-1.2
sys/dev/ic/mfireg.h				1.1-1.2
sys/dev/ic/mfivar.h				1.1-1.2
sys/dev/pci/files.pci				1.274
sys/dev/pci/mfi_pci.c				1.1-1.2

	Add mfi(4), a driver for LSI Logic & Dell MegaRAID SAS RAID controller.
	Tested on NetBSD-i386 and NetBSD-amd64.
	[bouyer, ticket #286]

distrib/sets/lists/man/mi			1.959
share/man/man4/Makefile				1.417
share/man/man4/bnx.4				1.1-1.2
sys/arch/amd64/conf/GENERIC			1.123
sys/arch/amd64/conf/INSTALL			1.62
sys/arch/i386/conf/ALL				1.76
sys/arch/i386/conf/GENERIC			1.803
sys/arch/i386/conf/GENERIC_LAPTOP		1.218
sys/arch/i386/conf/INSTALL			1.299
sys/arch/i386/conf/INSTALL_LAPTOP		1.112
sys/arch/i386/conf/XEN2_DOM0			1.20
sys/dev/microcode/bnx/bnxfw.h			1.1-1.2
sys/dev/pci/files.pci				1.275
sys/dev/pci/if_bnx.c				1.1
sys/dev/pci/if_bnxreg.h				1.1

	Add bnx(4), a driver for Broadcom NetXtreme II 10/100/1000 Ethernet
	device. Tested on NetBSD-i386 and NetBSD-amd64.
	[bouyer, ticket #287]

share/man/man4/pci.4				1.85

	Add refences to bnx(4) and mfi(4).
	[bouyer, ticket #288]

sys/kern/exec_script.c				1.53
sys/kern/kern_exec.c				1.233
sys/sys/exec.h					1.115

	Remove the third argument from check_exec() and just check for ep_flags
	in the exec_package to know if we need to use VERIEXEC_DIRECT or
	VERIEXEC_INDIRECT.
	[elad, ticket #294]

