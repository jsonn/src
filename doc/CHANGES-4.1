#	$NetBSD: CHANGES-4.1,v 1.1.2.29 2008/02/22 22:09:49 bouyer Exp $

A complete list of changes from the NetBSD 4.0 release to the NetBSD 4.1
release:

File						Revision(s)
----						--------
gnu/usr.bin/groff/tmac/mdoc.local		patch
sys/sys/param.h					patch

	Welcome to 4.0_STABLE

sys/arch/amd64/amd64/bios32.c			1.6
sys/arch/amd64/amd64/mainbus.c			1.17
sys/arch/amd64/conf/GENERIC			1.151
sys/arch/amd64/conf/files.amd64			1.39 via patch
sys/arch/x86/x86/ipmi.c				1.12
sys/arch/x86/x86/ipmi.c				1.8
sys/dev/DEVNAMES				1.228

	Use PRIx64 for a 64-bit quantity instead of llx in a debug print.
	Add (commented-out) support for IPMI on amd64--pretty much copied straight
	from i386.
	Check for duplicate sensor names in the IPMI table.  If a duplicate name
	is found, try to make it unique by appending a count (1-99) to the sensor
	description (truncating, if necessary).
	[briggs, ticket #989]

sys/dev/raidframe/rf_netbsdkintf.c		1.231 via patch

	Implement dumping kernel cores to RAID 1 sets.  The component used
	for the dump is selected in this order of preference:
	   1) the master
	   2) a used_spare of the master
	   3) the slave
	   4) a used_spare of the slave
	[oster, ticket #1014]

sys/dev/pci/arcmsr.c				patch
sys/dev/pci/arcmsrvar.h				patch
sys/dev/pci/pcidevs				patch
sys/dev/pci/files.pci				patch
sys/arch/i386/conf/GENERIC			patch
sys/arch/i386/conf/XEN2_DOM0			patch
sys/arch/i386/conf/INSTALL_LARGE		patch
sys/arch/amd64/conf/GENERIC			patch
sys/arch/amd64/conf/INSTALL			patch
share/man/man4/Makefile				patch
share/man/man4/arcmsr.4				patch
distrib/sets/lists/man/mi			patch

	Add the Areca Technology Corporation SATA RAID controller driver,
	ported from OpenBSD.
	[christos, ticket #1037]
xsrc/xfree/xc/lib/font/bitmap/pcfread.c		1.3

	Apply security fix for CVE-2008-0006.
	[tron, ticket #1047]

distrib/hp700/Makefile				1.3
distrib/hp700/sysnbsd/Makefile			1.1
distrib/notes/common/netboot			1.32
distrib/notes/common/sysinst			1.84
distrib/notes/common/xfer			1.61
distrib/notes/hp700/Makefile			1.2
distrib/notes/hp700/hardware			1.4
distrib/notes/hp700/install			1.2
distrib/notes/hp700/upgrade			1.2
distrib/notes/hp700/xfer			1.2

	Improve hp700 install notes somewhat.
	Actually build and install a SYSNBSD.
	[skrll, ticket #1035]

usr.bin/xargs/Makefile				1.4
usr.bin/xargs/pathnames.h			1.6
usr.bin/xargs/strnsubst.c			1.1
usr.bin/xargs/xargs.1				1.19
usr.bin/xargs/xargs.c				1.16, 1.18

	Bring in xargs from FreeBSD to gain -I, -J etc. but keep our
	GNU compatible exit values. Fixes PRs 36154 and 37666.
	[apb, ticket #1036]

distrib/sets/lists/base/mi			1.712
distrib/sets/lists/comp/mi			1.1035
distrib/sets/lists/man/mi			1.1010
sys/netinet/tcp_usrreq.c			1.133
sys/netinet/tcp_var.h				1.148
usr.sbin/Makefile				1.228 via patch
usr.sbin/tcpdrop/Makefile			1.1
usr.sbin/tcpdrop/tcpdrop.8			1.1
usr.sbin/tcpdrop/tcpdrop.c			1.1 - 1.3

	Import tcpdrop(8) from OpenBSD
	[ghen, ticket #1039]

sys/arch/algor/algor/algor_p4032_intr.c		1.15, 1.17 via patch
sys/arch/algor/algor/algor_p5064_intr.c		1.18, 1.20 via patch
sys/arch/algor/algor/algor_p6032_intr.c		1.12, 1.14 via patch
sys/arch/algor/algor/locore_machdep.S		1.4
sys/arch/algor/dev/mcclock_mainbus.c		1.7
sys/arch/algor/isa/mcclock_isa.c		1.9
sys/arch/mips/mips/mips3_clock.c		1.8, 1.9

	Fix botch on MI todr(9) migration of algor on September 2006:
	initialize necessary values for mips3_delay().
	[tsutsui, ticket #1040]

sys/dev/ic/bt8xx.h				1.9
sys/dev/pci/bktr/bktr_audio.c			1.18
sys/dev/pci/bktr/bktr_core.c			1.46
sys/dev/pci/bktr/bktr_core.h			1.10
sys/dev/pci/bktr/bktr_os.c			1.49
sys/dev/pci/bktr/bktr_reg.h			1.18

	Don't assume that sizeof(long) == sizeof(int);
	makes bktr work on amd64.
	[jmcneill, ticket #1046]

sys/dev/usb/if_aue.c				1.107, 1.108 via patch	
sys/dev/usb/if_auereg.h				1.19, 1.20 via patch 

	Prevents hang on close by unprotected creation of the formerly used
	workqueue item.
	[is, ticket #1048]

src/sys/arch/x86/isa/clock.c 1.23 via patch
	fixes clock accounting problem in i8254_get_timecount that caused
	the auich auich_calibrate() function to get the wrong ac97 freq
	(may cause audio to play at wrong speed on some systems).
	[chuck, ticket #1049]

sys/netinet/tcp_usrreq.c			1.134

	Protect inet6_ident_core() with #ifdef INET6, fixes building without
	options INET6.
	[joerg, ticket #1057]

sys/dev/pci/azalia_codec.c			1.48

	When converting mixer values to hardware values, round up. This makes
	stepping and restore actually work.
	[joerg, ticket #982]

lib/libkvm/kvm_sparc64.c			1.11
sys/arch/sparc64/include/kcore.h		1.5
sys/arch/sparc64/sparc64/pmap.c			1.201

	Extend the sparc64 cpu kcore segment so that it records all kernel
	mappings done via locked 4 MB pages.
	[martin, ticket #983]

sys/dev/pci/uhci_pci.c				1.38

	Be paranoid about disabling interrupts and acknowledging any pending
	interrupts while attaching uhci. Fixes recent problems with uvm_fault
	during uhci attach.
	[gavan, ticket #1000]

sys/arch/xen/xen/isa_machdep.c			1.9
sys/arch/xen/xen/pciide_machdep.c		1.7

	Properly setup the IO APIC for ISA and pciide compat interrupts too.
	Makes ACPI kernels works again with pciide controllers in compat mode.
	[bouyer, ticket #1001]

sys/dev/pci/if_bnx.c				1.11

	Reprogram multicast filter after SIOCADDMULTI / SIOCDELMULTI.
	[dyoung, ticket #1011]

sys/dev/scsipi/cd.c				1.270
sys/fs/udf/udf_subr.c				1.42
sys/sys/cdio.h					1.29

	Fix panics on certain UDF disc mounts.
	[reinoud, ticket #1004]

etc/Makefile					1.347

	Remove MKUUCP from RELEASEVARS.  It is no longer used in src.
	[minskim, ticket #1005]

sys/netinet6/in6_src.c				1.40

	Fix ipv6 ephemeral port allocation.
	[yamt, ticket #1006]

sys/fs/msdosfs/msdosfs_vnops.c			1.43

	Fix msdos rename routine.
	[pooka, ticket #1007]

sys/fs/tmpfs/tmpfs_pool.c			1.11

	Fix a diagnostic panic if the pool allocator is called with NOWAIT.
	[pooka, ticket #1008]

sys/fs/tmpfs/tmpfs_vnops.c			1.43

	Fix a race condition in rename.
	[pooka, ticket #1010]

distrib/sets/lists/etc/mi			1.186
etc/Makefile					1.338
etc/login.conf					1.1-1.2

	Add a default login.conf.
	[elad, ticket #1012]

sys/arch/atari/dev/wdc_mb.c			1.29-1.30
        Apply missed following MI wdc changes to atari's mainbus wdc backend:
        - make bus space handles an array for each command register
          http://mail-index.netbsd.org/source-changes/2003/11/27/0036.html
          (note we no longer have to specify stride for wdc after this change)
        - add the notion of "shadow register"
          http://mail-index.netbsd.org/source-changes/2004/05/25/0048.html
        Problem reported by Alan Hourihane in PR port-atari/37464.
	[tsutsui, ticket #1013]

usr.sbin/postinstall/postinstall		1.56 via patch

	Update URLs after website reorganization in the motd check. PR#37070.
	[jnemeth, ticket #1022]

share/examples/puffs/ssshfs/ssshfs.c		patch

	Fix symlink creation, from Dieter Rolants in PR#37549
	[pooka, ticket #1023]

sbin/newfs/mkfs.c				1.104
sbin/newfs/mount_mfs.8				1.15

	PR/37503 - De Zeurkous -- inaccurate description of -s option
	PR/37155 - Marcelo Schmidt -- specifying too large of a size
	causes segvs
	[jnemeth, ticket #1024]

sys/arch/sun3/sun3/obmem.c			1.24

	Pass correct size to allocate struct obmem_softc. Fixes an
	occasional panic on my 3/80.
	[tsutsui, ticket #1025]

sys/arch/cobalt/cobalt/machdep.c		1.91

	In icu_intr_establish(), don't panic if the specified irq
	is already in use and just return NULL instead.
	[tsutsui, ticket #1026]

common/dist/zlib/inflate.c			1.4

	Disable a sanity check output buffer != NULL in _STANDALONE case.
	Some kernels are loaded at address 0x0 by bootloaders and
	output buffer address could be zero in such case.
	[tsutsui, ticket #1027]

sys/dev/ic/i82557.c				1.105
sys/dev/ic/i82557reg.h				1.19
sys/dev/ic/i82557var.h				1.36

	Pull several fixes from OpenBSD's fxp.c, fixing PR#30560 as
	well as random pool corruption.
	[tsutsui, ticket #1028]

usr.sbin/ndiscvt/ndiscvt.8			1.6

	PR/37604 - Danilo Vidovic -- we do have a ndis(4) man page
	[jnemeth, ticket #1029]

sys/arch/sparc64/sparc64/autoconf.c		1.147

	Fix unusued variable warning (depending on options).
	[martin, ticket #1030]

dist/nawk/lex.c					1.8

	Bring back the fix in revision 1.6, apparently accidentally lost 
	during last merge, to allow escape of a newline in string literals.
	[christos, ticket #1034]

usr.bin/systat/extern.h				1.38
usr.bin/systat/keyboard.c			1.24
usr.bin/systat/main.c				1.41

	don't call curses from a signal handler!
	[christos, ticket #1031]

sys/net/bpf_filter.c				1.34

	PR/37663: Guy Harris: bpf_validate rejects valid programs that use the
	multiply instruction
	[christos, ticket #1032]

sbin/fdisk/fdisk.c				1.114

	Add a sanity check to avoid possible division by zero, and
	adjust sector numbers _after_ "Sanity check the data against all
	zeroes".  PR#37656
	[tsutsui, ticket #1052]

sbin/fdisk/fdisk.c				1.107

	Don't print drive serial number if -S (setting shell variables)
	is specified.
	[tsutsui, ticket #1053]

games/larn/bill.c				1.9
games/larn/header.h				1.18 via patch
games/larn/main.c				1.21
games/larn/scores.c				1.16 via patch

	Since games are (now) setgid, not setuid, it is no longer necessary to
	manipulate the effective uid, only the effective gid.
	Use mkstemp to make the temporary files used when you win.
	[dholland, ticket #1067]

sys/dev/audio.c					1.233

	Don't enter an infinite loop in audio_read() when the sc->sc_rustream
	buffer is full.  Fixes kern/34659.
	[gson, ticket #1054]

sys/dev/usb/uhub.c				1.94

	Speed up uhub attachment considerably.
	[jmcneill, ticket #1056]

usr.sbin/services_mkdb/services_mkdb.8		1.6 via patch

	Update pathnames to the services and netgroups databases after
	their move to /var/db.
	[jnemeth, ticket #1033]

sys/arch/ews4800mips/conf/RAMDISK		1.7

	Disable agr(4) to shrink an install kernel.
	[tsutsui, ticket #1055]

sys/netipsec/ipsec_mbuf.c			1.10 via patch

	Avoid a buffer overrun which could crash a FAST_IPSEC kernel.
	PR#30124.
	[seanb, ticket #1015]

sys/dev/usb/ukbd.c				1.96

	Add support for function keys F16 to F19 as present on e.g. the new
	Apple aluminum keyboard. PR#37788.
	[tron, ticket #1060]

xsrc/xfree/xc/programs/Xserver/hw/xfree86/os-support/bsd/bsd_KbdMap.c 1.11
	Add another translation table to make the modular kbd driver cope  
	with our AT/PS2 pseudo XT scancodes. Tested on shark and sgimips
	with an IBM  Model M
	[macallan, ticket #1062]

sys/arch/i386/stand/bootxx/Makefile.bootxx	1.30

	Add EPIA_HACK so that boot loaders work on EDEN 5000 processors.
	[sborrill, ticket #1064]

sys/arch/hpcmips/conf/GENERIC			1.199
sys/arch/hpcmips/conf/TX3912			1.68
sys/arch/hpcmips/conf/TX3922			1.80
sys/arch/hpcmips/tx/tx39power.c			1.18
sys/arch/mips/mips/cache_tx39.c			1.6
sys/arch/mips/mips/locore_mips1.S		1.64

	Make GENERIC and TX3922 kernels boot on TX3922 based machines
	[tsutsui, ticket #1065]

sys/arch/hpcmips/conf/GENERIC			1.200
sys/arch/hpcmips/conf/LROUTER			1.36
sys/arch/hpcmips/conf/MPC303			1.48
sys/arch/hpcmips/conf/TX3912			1.69
sys/arch/hpcmips/conf/TX3922			1.81
sys/arch/hpcmips/conf/TX3922			1.82
sys/arch/hpcmips/conf/VR41XX			1.43

	Add options COMPAT_16, COMPAT_20 and COMPAT_30 to non-GENERIC kernels.
	Requested by Risto Sainio in PR port-hpcmips/37911.
	Add a definition for Fujitsu PenCentra 200 and enable wsmouse at ucbtp.
	Tested and requested by Risto Sainio.
	[tsutsui, ticket #1066]

etc/namedb/root.cache				1.12, 1.13

	Update to 2008020400 version
	[ghen, ticket #1068]

distrib/notes/common/sysinst			patch
	fix hp700 addition
	[skrll, ticket #1071]

usr.bin/stat/stat.c				1.25

	Fix a segfault when doing 'stat -f %R' on the stdin file handle,
	instead fake the filename '(stdin)' like the %N format.
	[mlelstv, ticket #1072]

usr.sbin/postinstall/postinstall		1.57, 1.58

	Don't fail the X11 check if "/usr/X11R6/lib" doesn't exist. This is
	perfectly valid setup (e.g. no X11 or modular X11 from "pkgsrc").
	Avoid error message in "obsolete" check if "/usr/X11R6/lib"
	doesn't exist.
	[tron, ticket #1073]

sys/dev/pci/pcidevs				1.929
sys/dev/pci/pcidevs.h				regen
sys/dev/pci/pcidevs_data			regen

	Import PCI ids for the Matrox MGA G200e and the Intel E7230 and 82975X
	chipsets from OpenBSD.
	[tron, ticket #1074]

sys/arch/sh3/sh3/exception_vector.S		1.21 - 1.30
sys/arch/sh3/sh3/genassym.cf			1.11 - 1.12
sys/arch/sh3/sh3/pmap.c				1.63

	Implement fast path TLB miss handling.  Walk the page table without
	creating a trapframe, with exceptions disabled and using only BANK1
	registers.  If a valid pte is found, load it and return.  Otherwise
	create a trapframe and proceed to the full-blown C handler.
	[uwe, ticket #1075]

sys/kern/kern_malloc.c				1.117 via patch

	malloc: fix freelist corruption.
	[yamt, ticket #1076]

sys/arch/amd64/include/acpi_func.h		1.3

	Re-sync the (broken) amd64 ACPI Global Lock macros with their i386
	counterparts.
	[scw, ticket #1077]

share/man/man4/ddb.4				1.110, 1.111 via patch

	Add magic keyboard sequence for NetBSD-amd64.
	[tron, ticket #1079]

sys/netnatm/natm.c				1.13
sys/netnatm/natm_proto.c			1.10

	Properly define the domain, and #ifdef out the sysctl routine
	which does nothing.
	[jnemeth, ticket #1081]

sys/dev/usb/uplcom.c				1.59, 1.61 via patch
sys/dev/usb/usbdevs				patch
sys/dev/usb/usbdevs.h				regen
sys/dev/usb/usbdevs_data.h			regen

	Add some initialization magic from FreeBSD. This makes it work with
	the more recent PL2303 revision 4.
	[mlelstv, ticket #1088]

sbin/veriexecctl/veriexecctl.8:			patch

	reflect reality in the veriexecctl(8) man-page.
	[elad, ticket #1080]

