#	$NetBSD: CHANGES-2.1,v 1.1.2.14 2005/01/30 14:19:59 he Exp $

A complete list of changes from the NetBSD 2.0 release to the NetBSD 2.1 
release

File						Revision(s)
----						--------
sys/sys/param.h                                 patch
share/tmac/doc-common                           patch
gnu/usr.bin/groff/tmac/mdoc.local               patch

	Welcome to 2.0_STABLE

sys/dev/mii/igphy.c				1.5
sys/dev/mii/igphyreg.h				1.2
sys/dev/pci/if_wmreg.h				1.12
sys/dev/pci/if_wm.c				1.78

	Fix major performance issues with the i82547 Gig-E chip:
	- enable the SmartSpeed work-around code for the IGP phy, with some
	  minor adjustments.
	- add some useful constants related to the Packet Buffer Allocation
	  register.
	- add the Receive and Transmit Data FIFO registers.
	- change the Tx:Rx on-chip RAM allocation ratio based on MTU.
	- On the 82547, keep track of how much of the Tx FIFO has been used.
	[thorpej, ticket #897]

sys/dev/pci/if_sk.c				1.11
sys/dev/pci/if_skreg.h				1.3
sys/dev/pci/if_skvar.h				1.4

	Fix Yukon ram sizing.
	Fix tx queue (slist can be corrupted when tx interrupts hit within
	tx_encap.
	Lower interrupt moderation timer to (improves performance).
	Improve chip identification. (from linux sk98lin driver).
	Keep tx queue running by kicking the tx bmu repeatedly.
	[abs, ticket #973]

sys/arch/powerpc/powerpc/trap.c			1.104

	Make sure to do setenv/unsetenv in pairs.  This prevents panics in
	DIAGNOSTIC kernel when crossing segment boundaries.
	[matt, ticket #985]

sys/arch/macppc/conf/INSTALL			1.78

	Now that we have ofwboot load at 0xe00000, it doesn't make sense for
	this kernel to load at 0x800000 - move back to the default and we
	have around 13 MB of space for the kernel.
	[wrstuden, ticket #951]

sys/arch/sparc64/sparc64/pmap.c			1.157

	Do the invalidation of the (virtually-addressed) L1 cache in
	pmap_remove_all() (ie. just before we skip the per-page cache
	invalidations while tearing down each context) instead of just
	before we recycle all the contexts in ctx_alloc().  The latter
	is not good enough since a (physically tagged) L1 cache line is
	valid for all contexts, not just the one that was used to
	instantiate it. PR#24126, PR#25669 and PR#27730.
	[martin, ticket #1013]

sys/arch/sparc64/sparc64/pmap.c			1.158

	Better return value checking for pseg_get/pseg_set. Turn Debugger()
	calls into proper panics and sprinkle some KASSERTs. PR#27288.
	[martin, ticket #1014]

lib/libc/arch/sparc64/gen/_setjmp.S		1.6

	Replace the stack unwinding by a much simpler solution taken from
	../../arch/sparc/gen/_setjmp.S rev. 1.6. This ended up to be
	~identical to the OpenBSD change triggered by the same sparc change.
	[martin, ticket #1020]

lib/libc/arch/x86_64/gen/swapcontext.S 		1.3

	Use correct stack offsets after pushing values onto it.
	PR#28486.
	[hira, ticket #1029]

sys/net/if_media.c				1.23

	Add malloc_type M_IFMEDIA and use it for both malloc'ing and free'ing 
	ifmedia_entrys to prevent panic(9) in DIAGNOSTIC kernels.
	[dyoung, ticket #1030]

sys/arch/xen/i386/locore.S			1.7

	HYPERVISOR_yield is one of the hypervisor calls that's "overloaded";
	it does different things depending what's in %ebx.

	We weren't setting %ebx here *at all*; so we did not get
	SCHEDOP_yield, which was what was wanted; so unpredictable things
	happened, notably immediate return to the NetBSD idle loop, in
	other words spinning on CPU.
	[tls, ticket #1043]

sys/arch/xen/i386/machdep.c			1.11

	Terminate the domain on RB_HALT, not just on reboot.  This avoids
	looping around a cngetc() that will never return while "halted".
	[tls, ticket #1045]

sys/arch/sh3/sh3/mmu.c				1.10
sys/arch/sh3/sh3/mmu_sh3.c			1.7
sys/arch/sh3/sh3/mmu_sh4.c			1.8

	Protect accesses to PTE/TLB registers with 
	_cpu_exception_suspend()/_cpu_exception_resume() pair. Prevents 
	spontaneous reboot under heavy load
	[tsutsui, ticket #1072]

sys/nfs/nfsnode.h				patch
sys/nfs/nfs_vnops.c				patch

	nfs_lookup: check n_nctime for positive entries as well to improve
	cache consistency.
	[yamt, ticket #1077]

sys/nfs/nfs.h					patch
sys/nfs/nfs_socket.c				patch
sys/nfs/nfs_var.h				patch
sys/nfs/nfs_vnops.c				patch
sys/nfs/nfsm_subs.h				patch

	Don't do kludge for a reply to a retransmitted request
	unless we actually retransmitted the request.
	[yamt, ticket #1078]

sys/nfs/nfs_subs.c				1.140
sys/nfs/nfsnode.h				1.53

	Invalidate cache if filesize is changed besides our activity
	because it means that were out of sync with the server.
	[yamt, ticket #1079]

sys/dev/ic/tulip.c				1.130

	Silence the 'receive process failed to idle' message on the Davicom 
	DM9102A.
	[sketch, ticket #1084]

usr.sbin/ypserv/ypinit/ypinit.sh		1.12

	Fix a bug which caused "ypinit" to die with a strange error message
	if "/var/yp/binding" does not exist.
	[tron, ticket #893]

sys/dev/pci/if_wm.c				1.79 via patch
sys/dev/pci/if_wmreg.h				1.13

	Largest Tx descriptor buffer size is actually 4K.
	[thorpej, ticket #898]

sys/dev/pci/if_wm.c				1.80 via patch

	Restructure the loop in wm_start() that passes over the
	DMA map segments slightly to make it easier to drop in
	errata work-arounds that require adding extra descriptors
	onto the end of the packet.
	[thorpej, ticket #899]

dist/ntp/ntpd/ntp_io.c				1.11
dist/ntp/ntpd/ntp_proto.c			1.4

	Fix core dump problem if local system and ntp server do
	not have overlapping protocol family support (IPv4 vs.
	IPv6).  Instead, report server as unreachable, and ignore
	entry.  Fixes PR#27137.
	[christos, ticket #901]

sys/kern/sysv_sem.c				1.55

	Update sem_otime on successful call to semop().
	Fixes long-standing bug in the SYSV semaphore code which
	causes an example in Stevens' UNPv2 to fail when trying
	to compensate for a race condition in a file locking
	implementation.
	[briggs, ticket #903]

x11/Xserver/Makefile				1.13
x11/Xserver/Makefile.common			1.19
x11/Xserver/miext/Makefile			1.2
x11/Xserver/miext/shadow/Makefile		1.3
x11/Xserver/miext/shadow/Makefile.shadow	1.1 (new)
x11/Xserver/miext/shadow/module/Makefile	1.1 (new)
x11/Xserver/miext/layer/Makefile		1.3
x11/Xserver/miext/layer/Makefile.layer		1.1 (new)
x11/Xserver/miext/layer/module/Makefile		1.1 (new)
distrib/sets/lists/xserver/md.amd64		1.9
distrib/sets/lists/xserver/md.cats		1.5
distrib/sets/lists/xserver/md.i386		1.25
distrib/sets/lists/xserver/md.macppc		1.17
distrib/sets/lists/xserver/md.sgimips		1.7

	Build and install libshadow.a and liblayer.a.
	Fixes PR#27156.
	[rtr, tickets 905, 906, 907]

etc/rc.d/syslogd				1.15

	Use "load_rc_config `basename chrootdirscript`" in a subshell
	to determine the rc.conf(5) setting for chrootdirscript, incase
	the configuration for that is in /etc/rc.conf.d/chrootdirscript.
	Fixes PR#26478.
	[lukem, ticket #912]

usr.bin/passwd/krb5_passwd.c			1.12

	Switch to krb5_set_password that can handle the RFC3244 (as
	well as the older change password protocol).  Should enable
	changing password in a Windows2000 (or later) domain.
	[lha, ticket #917]

sys/arch/sparc64/dev/auxio.c			1.13

	In auxio_blink(), only toggle the AUXIO_LED_LED bit, don't
	clear the others.  It looks like bit 3 control the on-board
	le's link test, clearing it breaks the interface (no link
	detected on the remote end). Bit 3 is defined as AUXIO4M_LTE
	(link-test enable) for sun4m systems (maybe all the AUXIO4M_*
	bits are valid on the Ultra/1 too?).
	Tested on Ultra/1 and Ultra/5.  Fixes PR#25039.
	[bouyer, ticket #924]

lib/libc/citrus/citrus_mmap.c			1.2

	Correct check for mmap return value.  Also clean up
	the error path, convert to KNF, and use the proper stat
	macro.  Fixes PR#27283.
	[christos, ticket #931]

sys/fs/smbfs/smbfs_vnops.c			1.45

	Import a change from FreeBSD: use DENYNONE to give unixy
	semantics of permitting everything not forbidden by
	permissions.  I.e. denial is up to the server with
	clients/openers needing to use advisory locks for further
	control.  Fixes file access problem when the file is already
	open on the server.
	[peter, ticket #933]


sys/arch/alpha/a12/if_ade.c			1.23
sys/arch/amiga/dev/if_ed.c			1.46
sys/arch/amiga/dev/if_es.c			1.35
sys/arch/mac68k/dev/if_mc.c			1.24
sys/arch/mac68k/dev/if_sn.c			1.35
sys/arch/mac68k/nubus/if_netdock_nubus.c	1.5
sys/arch/macppc/dev/am79c950.c			1.16
sys/arch/macppc/dev/if_bm.c			1.23
sys/arch/macppc/dev/if_gm.c			1.23
sys/arch/mips/alchemy/dev/if_aumac.c		1.12
sys/arch/newsmips/apbus/if_sn.c			1.15
sys/arch/next68k/dev/mb8795.c			1.34
sys/arch/playstation2/dev/if_smap.c		1.6
sys/arch/powerpc/ibm4xx/dev/if_emac.c		1.19
sys/arch/sgimips/hpc/if_sq.c			1.21
sys/arch/sun3/dev/if_ie.c			1.40
sys/dev/bi/if_ni.c				1.23
sys/dev/i2o/iopl.c				1.14
sys/dev/ic/aic6915.c				1.12
sys/dev/ic/atw.c				1.80
sys/dev/ic/awi.c				1.66
sys/dev/ic/cs89x0.c				1.15
sys/dev/ic/dp8390.c				1.54
sys/dev/ic/dp83932.c				1.10
sys/dev/ic/elink3.c				1.108
sys/dev/ic/elinkxl.c				1.75
sys/dev/ic/gem.c				1.32
sys/dev/ic/hme.c				1.43
sys/dev/ic/i82557.c				1.88
sys/dev/ic/i82586.c				1.49
sys/dev/ic/smc91cxx.c				1.49
sys/dev/ic/i82596.c				1.3
sys/dev/ic/lance.c				1.30
sys/dev/ic/lemac.c				1.26
sys/dev/ic/mb86960.c				1.58
sys/dev/ic/mtd803.c				1.6
sys/dev/ic/rtl81x9.c				1.47
sys/dev/ic/seeq8005.c				1.36
sys/dev/ic/sgec.c				1.23
sys/dev/ic/smc83c170.c				1.56
sys/dev/ic/wi.c					1.188
sys/dev/pci/if_bge.c				1.77
sys/dev/pci/if_de.c				1.112
sys/dev/pci/if_dge.c				1.7
sys/dev/pci/if_pcn.c				1.24
sys/dev/pci/if_re.c				1.6
sys/dev/pci/if_sip.c				1.96
sys/dev/pci/if_sk.c				1.12
sys/dev/pci/if_ste.c				1.20
sys/dev/pci/if_stge.c				1.22
sys/dev/pci/if_tl.c				1.66
sys/dev/pci/if_txp.c				1.8
sys/dev/pci/if_vr.c				1.70
sys/dev/pci/if_wm.c				1.83
sys/dev/pcmcia/if_cnw.c				1.29
sys/dev/pcmcia/if_ray.c				1.54
sys/dev/qbus/if_qe.c				1.58
sys/dev/sbus/be.c				1.44
sys/dev/sbus/qe.c				1.33
sys/dev/scsipi/if_se.c				1.51
sys/dev/usb/if_aue.c				1.88
sys/dev/usb/if_udav.c				1.4
sys/dev/usb/if_url.c				1.12

	When adding or deleting multicast addresses, only change
	the address filter if the interface is marked RUNNING.
	Fixes PR#27678.
	[thorpej, ticket #939]

sys/dev/ic/tulip.c				1.129

	When adding or deleting multicast addresses, only change
	the address filter if the interface is marked RUNNING.
	Fixes PR#27678.
	[thorpej, ticket #940]

sys/dve/isa/if_iy.c				1.65

	When adding or deleting multicast addresses, only change
	the address filter if the interface is marked RUNNING.
	Fixes PR#27678.
	[thorpej, ticket #941]

sys/dev/qbus/if_qt.c				1.5

	In qtinit(), don't skip initialization if the interface is
	already RUNNING.  ether_ioctl() will call (*if_init)() when
	flags change.  Instead, do what other drivers do, and stop
	the interface in this case before re-initializing.
	In qtioctl(), now that qtinit() does the right thing, remove
	the check for the IFF_PROMISC change.
	When adding or deleting multicast addresses, only change
	the address filter if the interface is marked RUNNING.
	Fixes PR#27678.
	[thorpej, ticket #942]

sys/dev/ic/i82596.c				1.4

	Make iee_ioctl() look more like other drivers, and fix a
	missing splx(s) as a side-effect.  Don't bother handling
	IFF_PROMISC here, because ether_ioctl() already calls
	(*if_init)() to handle flag changes.
	When adding or deleting multicast addresses, only change
	the address filter if the interface is marked RUNNING.
	Fixes PR#27678.
	[thorpej, ticket #943]

sys/dev/pci/auvia.c				1.43
sys/dev/pci/auviavar.h				1.6

	Add support for suspending/resuming.  Fixes PR#26432.
	[kent, ticket #949]

bin/pax/options.c				1.82

	Fix broken cpio(1) option handling:
	 o "cpio -i -t" should list the contents of a file, not
	   extract it.
	 o Don't extract a file when only option "-d" is given.
	Fixes PR#26513.
	[tron, ticket #952]

sys/netinet6/ipsec.c				1.98-1.99

	Add a missing break.
	[itojun, ticket #954]

usr.sbin/syslogd/syslogd.c			1.68

	Postpone initial setting of the alarm timer until after
	the call to daemon(), as the timer would be cleared by
	deamon's fork().  Fixes PR#19558.
	[heas, ticket #958]

sys/dev/pci/cs4281.c				1.21

	Make recording of clct(4) work, namely:
	 o cs_4281_intr: advance a pointer after copying data
	 o cs_4281_trigger_input: fix an inverted condition about
	   dma mode
	[yamt, ticket #967]

sys/nfs/nfs_bio.c				1.122
sys/nfs/nfs_subs.c				1.138
sys/nfs/nfsnode.h				1.50

	Since daddr_t is 64-bit these days, simply use nfs directory
	cookies as buffer cache indexes.  This should make the
	regress/sys/fs/getdents test work.  Fixes PR#27112.
	[yamt, ticket #968]
