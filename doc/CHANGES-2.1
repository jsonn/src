#	$NetBSD: CHANGES-2.1,v 1.1.2.10 2005/01/12 22:56:55 he Exp $

A complete list of changes from the NetBSD 2.0 release to the NetBSD 2.1 
release

File						Revision(s)
----						--------
sys/sys/param.h                                 patch
share/tmac/doc-common                           patch
gnu/usr.bin/groff/tmac/mdoc.local               patch

	Welcome to 2.0_STABLE

sys/dev/mii/igphy.c				1.5
sys/dev/mii/igphyreg.h				1.2
sys/dev/pci/if_wmreg.h				1.12
sys/dev/pci/if_wm.c				1.78

	Fix major performance issues with the i82547 Gig-E chip:
	- enable the SmartSpeed work-around code for the IGP phy, with some
	  minor adjustments.
	- add some useful constants related to the Packet Buffer Allocation
	  register.
	- add the Receive and Transmit Data FIFO registers.
	- change the Tx:Rx on-chip RAM allocation ratio based on MTU.
	- On the 82547, keep track of how much of the Tx FIFO has been used.
	[thorpej, ticket #897]

sys/dev/pci/if_sk.c				1.11
sys/dev/pci/if_skreg.h				1.3
sys/dev/pci/if_skvar.h				1.4

	Fix Yukon ram sizing.
	Fix tx queue (slist can be corrupted when tx interrupts hit within
	tx_encap.
	Lower interrupt moderation timer to (improves performance).
	Improve chip identification. (from linux sk98lin driver).
	Keep tx queue running by kicking the tx bmu repeatedly.
	[abs, ticket #973]

sys/arch/powerpc/powerpc/trap.c			1.104

	Make sure to do setenv/unsetenv in pairs.  This prevents panics in
	DIAGNOSTIC kernel when crossing segment boundaries.
	[matt, ticket #985]

sys/arch/macppc/conf/INSTALL			1.78

	Now that we have ofwboot load at 0xe00000, it doesn't make sense for
	this kernel to load at 0x800000 - move back to the default and we
	have around 13 MB of space for the kernel.
	[wrstuden, ticket #951]

sys/arch/sparc64/sparc64/pmap.c			1.157

	Do the invalidation of the (virtually-addressed) L1 cache in
	pmap_remove_all() (ie. just before we skip the per-page cache
	invalidations while tearing down each context) instead of just
	before we recycle all the contexts in ctx_alloc().  The latter
	is not good enough since a (physically tagged) L1 cache line is
	valid for all contexts, not just the one that was used to
	instantiate it. PR#24126, PR#25669 and PR#27730.
	[martin, ticket #1013]

sys/arch/sparc64/sparc64/pmap.c			1.158

	Better return value checking for pseg_get/pseg_set. Turn Debugger()
	calls into proper panics and sprinkle some KASSERTs. PR#27288.
	[martin, ticket #1014]

lib/libc/arch/sparc64/gen/_setjmp.S		1.6

	Replace the stack unwinding by a much simpler solution taken from
	../../arch/sparc/gen/_setjmp.S rev. 1.6. This ended up to be
	~identical to the OpenBSD change triggered by the same sparc change.
	[martin, ticket #1020]

lib/libc/arch/x86_64/gen/swapcontext.S 		1.3

	Use correct stack offsets after pushing values onto it.
	PR#28486.
	[hira, ticket #1029]

sys/net/if_media.c				1.23

	Add malloc_type M_IFMEDIA and use it for both malloc'ing and free'ing 
	ifmedia_entrys to prevent panic(9) in DIAGNOSTIC kernels.
	[dyoung, ticket #1030]

sys/arch/xen/i386/locore.S			1.7

	HYPERVISOR_yield is one of the hypervisor calls that's "overloaded";
	it does different things depending what's in %ebx.

	We weren't setting %ebx here *at all*; so we did not get
	SCHEDOP_yield, which was what was wanted; so unpredictable things
	happened, notably immediate return to the NetBSD idle loop, in
	other words spinning on CPU.
	[tls, ticket #1043]

sys/arch/xen/i386/machdep.c			1.11

	Terminate the domain on RB_HALT, not just on reboot.  This avoids
	looping around a cngetc() that will never return while "halted".
	[tls, ticket #1045]

sys/arch/sh3/sh3/mmu.c				1.10
sys/arch/sh3/sh3/mmu_sh3.c			1.7
sys/arch/sh3/sh3/mmu_sh4.c			1.8

	Protect accesses to PTE/TLB registers with 
	_cpu_exception_suspend()/_cpu_exception_resume() pair. Prevents 
	spontaneous reboot under heavy load
	[tsutsui, ticket #1072]

sys/nfs/nfsnode.h				patch
sys/nfs/nfs_vnops.c				patch

	nfs_lookup: check n_nctime for positive entries as well to improve
	cache consistency.
	[yamt, ticket #1077]

sys/nfs/nfs.h					patch
sys/nfs/nfs_socket.c				patch
sys/nfs/nfs_var.h				patch
sys/nfs/nfs_vnops.c				patch
sys/nfs/nfsm_subs.h				patch

	Don't do kludge for a reply to a retransmitted request
	unless we actually retransmitted the request.
	[yamt, ticket #1078]

sys/nfs/nfs_subs.c				1.140
sys/nfs/nfsnode.h				1.53

	Invalidate cache if filesize is changed besides our activity
	because it means that were out of sync with the server.
	[yamt, ticket #1079]

sys/dev/ic/tulip.c				1.130

	Silence the 'receive process failed to idle' message on the Davicom 
	DM9102A.
	[sketch, ticket #1084]

usr.sbin/ypserv/ypinit/ypinit.sh		1.12

	Fix a bug which caused "ypinit" to die with a strange error message
	if "/var/yp/binding" does not exist.
	[tron, ticket #893]

sys/dev/pci/if_wm.c				1.79 via patch
sys/dev/pci/if_wmreg.h				1.13

	Largest Tx descriptor buffer size is actually 4K.
	[thorpej, ticket #898]

sys/dev/pci/if_wm.c				1.80 via patch

	Restructure the loop in wm_start() that passes over the
	DMA map segments slightly to make it easier to drop in
	errata work-arounds that require adding extra descriptors
	onto the end of the packet.
	[thorpej, ticket #899]

dist/ntp/ntpd/ntp_io.c				1.11
dist/ntp/ntpd/ntp_proto.c			1.4

	Fix core dump problem if local system and ntp server do
	not have overlapping protocol family support (IPv4 vs.
	IPv6).  Instead, report server as unreachable, and ignore
	entry.  Fixes PR#27137.
	[christos, ticket #901]

sys/kern/sysv_sem.c				1.55

	Update sem_otime on successful call to semop().
	Fixes long-standing bug in the SYSV semaphore code which
	causes an example in Stevens' UNPv2 to fail when trying
	to compensate for a race condition in a file locking
	implementation.
	[briggs, ticket #903]
