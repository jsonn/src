#	$NetBSD: CHANGES-3.0.4,v 1.1.2.20 2008/02/22 19:06:04 bouyer Exp $

A complete list of changes from the NetBSD 3.0.3 release to the NetBSD 3.0.4
release:

File						Revision(s)
----						--------
doc/README.files				patch
gnu/usr.bin/groff/tmac/mdoc.local		patch
sys/sys/param.h					patch

	Welcome to NetBSD 3.0.3_PATCH.

sys/dev/ic/pcdisplay_subr.c			1.33 via patch
sys/dev/ic/vga.c				1.95 via patch
sys/dev/ic/vga_raster.c				1.29 via patch
sys/dev/isa/ega.c				1.23 via patch
sys/dev/rasops/rasops.c				1.56 via patch

	Implement bounds checking in some places in display driver code to
	avoid the possibility of a local user panic.
	[mjf, ticket #1815]

dist/bind/bin/named/client.c			1.1.1.6 via patch
dist/bind/lib/dns/dispatch.c			1.1.1.7 via patch
dist/bind/lib/dns/include/dns/dispatch.h	1.1.1.5 via patch

	Fix for a security issue in BIND 9.3.x (CVE-2007-2926):
	Query id generation was cryptographically weak.
	[adrianp, ticket #1829]

sys/sys/socketvar.h				1.97
	Fix a bug in sblock() that has existed since revision 1.1 from BSD:
	correctly return an error if M_NOWAIT is passed to sblock() and the
	operation might block.  This remarkably subtle macro bug appears to
	be responsible for quite a few undiagnosed socket buffer corruption
	and mbuf-related kernel panics.
	[christos, ticket #1808]

sbin/ping/ping.c				1.83 - 1.85

	PR/28741: Michael Santos: ping does [not] drop root privileges
	[ghen, ticket #1818]

lib/libc/gen/Makefile.inc			1.143
lib/libc/gen/cgetcap.3				1.1 - 1.3
lib/libc/gen/getcap.3				delete

	Both libcurses and libc installed a getcap(3) manpage, and both used it
	as target for a bunch of MLINKS. This had the effect that whatever came
	last in install overwrote everything from the other camp.
	Solve this by renaming the libc page -- this makes sense because no
	function is really named "getcap" here.
	[bad, ticket #1821]

sys/kern/uipc_usrreq.c				1.98

	PR kern/32842:
	do not leak file descriptors when sending a datagram with SCM_RIGHTS
	fails. Patch from Gary Thorpe, based on changes in FreeBSD and work
	from Christian Biere.
	[martin, ticket #1820]

lib/libc/hash/sha2/sha2.c			patch
sys/crypto/ripemd160/rmd160.c			patch
sys/crypto/sha2/sha2.c				patch

	Fix SIGBUS issues on strict alignment issues. Use le32dec in RMD160
	as the data pointer to RMD160_Update doesn't have to be aligned.
	In SHA256_Update and SHA512_Update, only operate directly on the passed
	in data if no left-over in the context exists and the data is correctly
	aligned. The problem was exposed by the audit-packages rewrite in C
	and reported for the libnbcompat version in PR pkg/36662.
	[joerg, ticket #1812]

sys/arch/acorn32/conf/GENERIC			1.80 via patch
sys/arch/amd64/conf/GENERIC			1.154 via patch
sys/arch/amiga/conf/GENERIC			1.248 via patch
sys/arch/amiga/conf/GENERIC.in			1.61 via patch
sys/arch/arc/conf/GENERIC			1.148 via patch
sys/arch/atari/conf/GENERIC.in			1.68 via patch
sys/arch/cats/conf/GENERIC			1.116 via patch
sys/arch/hp300/conf/GENERIC			1.141 via patch
sys/arch/i386/conf/GENERIC			1.840 via patch
sys/arch/i386/conf/GENERIC.MPACPI		patch
sys/arch/i386/conf/GENERIC_LAPTOP		1.239 via patch
sys/arch/mac68k/conf/GENERIC			1.182 via patch
sys/arch/sgimips/conf/GENERIC32_IP2x		1.68 via patch
sys/arch/sgimips/conf/GENERIC32_IP3x		1.66 via patch
sys/arch/sparc/conf/GENERIC			1.200 via patch
sys/arch/sparc64/conf/GENERIC			1.88 via patch

	Remove iso(4) from GENERIC kernels.
	[adrianp, ticket #1826]

sys/dev/ieee1394/fwohci.c:			patch

	PR kern/36945 by Ross Philipson: Remove call to fwohci_desc_put() in
	an error path where fwohci_desc_get() has not been called yet.
	[christos, ticket #1835]

etc/defaults/security.conf			1.20
etc/security					1.104

	The location of the pkg_info binary can now be specified in
	/etc/security.conf.
	The default remains as /usr/sbin/pkg_info.  This should fix PR# 36746.
	[adrianp, ticket #1841]

sys/netinet/ip_input.c				1.253

	Fix PR kern/36800: in FAST_IPSEC, spl level may not be restored
	properly.
	[degroote, ticket #1840]

sys/dev/ic/mpt.c				1.9, 1.10 via patch
sys/dev/ic/mpt.h				1.6 via patch
sys/dev/ic/mpt_debug.c				patch
sys/dev/ic/mpt_mpilib.h				1.3 via patch
sys/dev/ic/mpt_netbsd.c				1.12 via patch
sys/dev/ic/mpt_netbsd.h				1.6 via patch
sys/dev/pci/mpt_pci.c				1.11 via patch
sys/dev/pci/pcidevs				patch
sys/dev/pci/pcidevs.h				regen
sys/dev/pci/pcidevs_data.h			regen

	Add support for newer SAS and similar devices to mpt(4). Tested with
	the LSI SAS1064 in a Sun x4200 server.
	These enhancements were developed by Garrett D'Amore and contributed
	to NetBSD by the TELES AG.
	[tron, ticket #1822]

sys/dev/ata/wd.c				1.345

	Add a workaround for drives with the LBA48 bug:
	if we get a "ID not found" error for a transfer crossing
	LBA48_THRESHOLD, and the drive is larger than 128GB,
	automatically add WD_QUIRK_FORCE_LBA48 to the drive's
	quirks and retry the transfers.  Hopefully this will
	obsolete the WD_QUIRK_FORCE_LBA48 quirk list ...
	[bouyer, ticket #1848]

doc/3RDPARTY					1.562
etc/namedb/root.cache				1.11

	Update to 2007110100 version
	[martti, ticket #1871, #1872]

usr.sbin/rpc.lockd/lock_proc.c			1.8

	Fix off-by-one error accessing "clnt_cache_addr" array which causes
	heap corruption. This will hopefully fix PR bin/37236.
	[tron, ticket #1873]

sys/netipsec/ipsec.c				1.34 via patch
sys/netipsec/ipsec_osdep.h			1.21 via patch
sys/netipsec/ipsec_output.c			1.23 via patch
sys/netipsec/xform_ah.c				1.19 via patch
sys/netipsec/xform_ipip.c			1.18 via patch

	The function ipsec4_get_ulp assumes that ip_off is in host order.
	This results in IPsec processing that is dependent on protocol
	and/or port can be bypassed.
	Bug report, analysis and initial fix from Karl Knutsson.
	Final patch and ok from degroote@
	[adrianp, ticket #1878]

sys/netinet6/ipcomp_input.c			1.28

	From FreeBSD:
	    In ipcomp6_input(), check 'md' not 'm' after a call to
	    m_pulldown(): 'm' may be a stale pointer at this point, and
	    we're interested in whether or not m_pulldown() failed.
	    Noticed by:     Coverity Prevent analysis tool
	Should fix PR 37410.
	[jdc, ticket #1879]

crypto/dist/openssl/ssl/ssl_lib.c		1.4

	apply a patch from openssl CVS to fix a remaining off-by-one error
	in an older security fix, see
	http://www.securityfocus.com/archive/1/480855/30/0/threaded
	(CVE-2007-4995)
	[drochner, ticket #1891]
xsrc/xfree/xc/lib/font/bitmap/pcfread.c		1.3

	Apply security fix for CVE-2008-0006.
	[tron, ticket #1896]

games/larn/bill.c				1.9
games/larn/header.h				1.18 via patch
games/larn/main.c				1.21
games/larn/scores.c				1.16 via patch

	Since games are (now) setgid, not setuid, it is no longer necessary to
	manipulate the effective uid, only the effective gid.
	Use mkstemp to make the temporary files used when you win.
	[dholland, ticket #1899]

etc/namedb/root.cache				1.12, 1.13

	Update to 2008020400 version
	[ghen, ticket #1900]

